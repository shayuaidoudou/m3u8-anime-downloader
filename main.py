#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
M3U8È´òÈÄü‰∏ãËΩΩÂô® - ‰∏ªÁ®ãÂ∫è
Áé∞‰ª£ÂåñÁöÑPySide6 GUIÁïåÈù¢
"""

import sys
import os
import threading
import time
import json
from pathlib import Path
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
    QGridLayout, QFormLayout, QLabel, QLineEdit, QPushButton, QProgressBar, 
    QTextEdit, QFileDialog, QSpinBox, QGroupBox, QFrame,
    QSystemTrayIcon, QMenu, QMessageBox, QSplitter, QTabWidget,
    QTableWidget, QTableWidgetItem, QHeaderView, QCheckBox,
    QComboBox, QDialog, QDialogButtonBox, QPlainTextEdit, QScrollArea
)
from PySide6.QtCore import (
    Qt, QThread, Signal, QTimer, QUrl, QPropertyAnimation, 
    QEasingCurve, QRect, QSize
)
from PySide6.QtGui import (
    QFont, QPalette, QColor, QIcon, QPixmap, QPainter, QLinearGradient,
    QAction, QDesktopServices
)
from m3u8_downloader import M3U8Downloader
from utils import (
    is_valid_m3u8_url, sanitize_filename, ensure_extension,
    format_time, get_available_filename, validate_output_path,
    extract_title_from_url
)
from config import DEFAULT_CONFIG, ERROR_MESSAGES, STATUS_MESSAGES


class DownloadWorker(QThread):
    """‰∏ãËΩΩÂ∑•‰ΩúÁ∫øÁ®ã"""
    progress_updated = Signal(dict)
    download_finished = Signal(bool)
    
    def __init__(self, downloader, m3u8_url, output_path, max_workers=10):
        super().__init__()
        self.downloader = downloader
        self.m3u8_url = m3u8_url
        self.output_path = output_path
        self.max_workers = max_workers
        self._is_running = True
    
    def run(self):
        """ËøêË°å‰∏ãËΩΩ"""
        try:
            self.downloader.max_workers = self.max_workers
            success = self.downloader.download(
                self.m3u8_url, 
                self.output_path, 
                self.progress_callback
            )
            self.download_finished.emit(success)
        except Exception as e:
            self.progress_updated.emit({
                'status': 'error', 
                'message': f'‰∏ãËΩΩÂá∫Èîô: {str(e)}'
            })
            self.download_finished.emit(False)
    
    def progress_callback(self, data):
        """ËøõÂ∫¶ÂõûË∞É"""
        if self._is_running:
            self.progress_updated.emit(data)
    
    def stop(self):
        """ÂÅúÊ≠¢‰∏ãËΩΩ"""
        self._is_running = False
        if hasattr(self.downloader, 'stop_download'):
            self.downloader.stop_download()


class ModernButton(QPushButton):
    """Áé∞‰ª£ÂåñÊåâÈíÆÊ†∑Âºè"""
    
    def __init__(self, text, primary=False, icon_text=""):
        super().__init__(text)
        self.primary = primary
        self.icon_text = icon_text
        self.setMinimumHeight(45)
        self.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        self.setCursor(Qt.PointingHandCursor)
        
        # Ê∑ªÂä†ÂõæÊ†áÊñáÊú¨
        if icon_text:
            self.setText(f"{icon_text} {text}")
        
        if primary:
            self.setStyleSheet("""
                QPushButton {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #ff6b9d, stop:0.5 #c44cfc, stop:1 #667eea);
                    color: white;
                    border: none;
                    border-radius: 15px;
                    font-weight: bold;
                    padding: 12px 24px;
                    box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                }
                QPushButton:hover {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #ff7fb0, stop:0.5 #d066ff, stop:1 #7b8ef0);
                    transform: translateY(-3px);
                    box-shadow: 0 12px 35px rgba(255, 107, 157, 0.6);
                }
                QPushButton:pressed {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #e55d8a, stop:0.5 #b142e3, stop:1 #5a6fd8);
                    transform: translateY(-1px);
                }
                QPushButton:disabled {
                    background: #ddd6fe;
                    color: #a78bfa;
                    box-shadow: none;
                }
            """)
        else:
            self.setStyleSheet("""
                QPushButton {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #fef7ff, stop:1 #f3e8ff);
                    color: #7c3aed;
                    border: 2px solid #ddd6fe;
                    border-radius: 15px;
                    padding: 12px 24px;
                    font-weight: bold;
                    box-shadow: 0 4px 15px rgba(196, 76, 252, 0.15);
                }
                QPushButton:hover {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #faf5ff, stop:1 #ede9fe);
                    border-color: #c44cfc;
                    color: #c44cfc;
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px rgba(196, 76, 252, 0.25);
                }
                QPushButton:pressed {
                    background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                        stop:0 #e9d5ff, stop:1 #ddd6fe);
                    transform: translateY(0px);
                }
                QPushButton:disabled {
                    background: #f9fafb;
                    color: #d1d5db;
                    border-color: #e5e7eb;
                    box-shadow: none;
                }
            """)


class ModernLineEdit(QLineEdit):
    """Áé∞‰ª£ÂåñËæìÂÖ•Ê°ÜÊ†∑Âºè"""
    
    def __init__(self, placeholder="", icon_text=""):
        super().__init__()
        self.setPlaceholderText(placeholder)
        self.setMinimumHeight(48)
        self.setFont(QFont("Microsoft YaHei", 11))
        
        # Ê∑ªÂä†ÂõæÊ†á
        if icon_text:
            self.setPlaceholderText(f"{icon_text} {placeholder}")
        
        self.setStyleSheet("""
            QLineEdit {
                border: 2px solid #ddd6fe;
                border-radius: 16px;
                padding: 14px 20px;
                font-size: 14px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #fef7ff, stop:1 #f9fafb);
                color: #374151;
                selection-background-color: #c44cfc;
                box-shadow: inset 0 2px 8px rgba(196, 76, 252, 0.08);
            }
            QLineEdit:focus {
                border-color: #c44cfc;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
                box-shadow: 0 0 0 4px rgba(196, 76, 252, 0.25), 
                           inset 0 2px 8px rgba(196, 76, 252, 0.1);
            }
            QLineEdit:hover {
                border-color: #a78bfa;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
            }
        """)


class ModernProgressBar(QProgressBar):
    """Áé∞‰ª£ÂåñËøõÂ∫¶Êù°Ê†∑Âºè"""
    
    def __init__(self):
        super().__init__()
        self.setMinimumHeight(10)
        self.setMaximumHeight(10)
        self.setTextVisible(False)
        self.setStyleSheet("""
            QProgressBar {
                border: none;
                border-radius: 8px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f3e8ff, stop:1 #e9d5ff);
                box-shadow: inset 0 2px 6px rgba(196, 76, 252, 0.15);
            }
            QProgressBar::chunk {
                border-radius: 8px;
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #ff6b9d, stop:0.3 #c44cfc, stop:0.7 #667eea, stop:1 #06b6d4);
                box-shadow: 0 0 15px rgba(255, 107, 157, 0.6), 
                           0 4px 12px rgba(196, 76, 252, 0.4);
            }
        """)


class DownloadTaskWidget(QFrame):
    """‰∏ãËΩΩ‰ªªÂä°ÁªÑ‰ª∂"""
    
    def __init__(self, task_name, url, output_path, custom_headers=None):
        super().__init__()
        self.task_name = task_name
        self.url = url
        self.output_path = output_path
        self.custom_headers = custom_headers or {}
        self.worker = None
        
        self.setFrameStyle(QFrame.NoFrame)
        self.setStyleSheet("""
            QFrame {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 rgba(255, 255, 255, 0.95), 
                    stop:0.25 rgba(254, 247, 255, 0.9), 
                    stop:0.5 rgba(240, 249, 255, 0.9), 
                    stop:0.75 rgba(243, 232, 255, 0.9),
                    stop:1 rgba(253, 242, 248, 0.95));
                border-radius: 20px;
                border: 2px solid #ddd6fe;
                margin: 12px 6px;
                box-shadow: 0 12px 35px rgba(196, 76, 252, 0.15),
                           0 0 0 1px rgba(255, 107, 157, 0.1) inset;
            }
            QFrame:hover {
                border-color: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #ff6b9d, stop:0.5 #c44cfc, stop:1 #a78bfa);
                box-shadow: 0 16px 50px rgba(196, 76, 252, 0.25),
                           0 0 20px rgba(255, 107, 157, 0.3),
                           0 0 0 1px rgba(196, 76, 252, 0.2) inset;
                transform: translateY(-2px);
            }
        """)
        
        self.setup_ui()
    
    def setup_ui(self):
        """ËÆæÁΩÆUI"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 16, 20, 16)
        layout.setSpacing(12)
        
        # ‰ªªÂä°Ê†áÈ¢òÂíåÁä∂ÊÄÅË°å
        header_layout = QHBoxLayout()
        
        # ‰ªªÂä°Ê†áÈ¢ò + ÂõæÊ†á
        title_label = QLabel(f"üåà {self.task_name} ‚ú®")
        title_label.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        title_label.setStyleSheet("""
            color: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                stop:0 #c44cfc, stop:1 #667eea); 
            padding: 4px 0;
            font-weight: bold;
        """)
        header_layout.addWidget(title_label)
        
        header_layout.addStretch()
        
        # Áä∂ÊÄÅÊ†áÁ≠æ
        self.status_label = QLabel("üå∏ ÂáÜÂ§á‰∏≠... ‚ô°")
        self.status_label.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        self.status_label.setStyleSheet("""
            color: #c44cfc; 
            padding: 6px 12px; 
            background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                stop:0 rgba(255, 107, 157, 0.1), 
                stop:1 rgba(196, 76, 252, 0.1)); 
            border-radius: 10px;
            border: 1px solid rgba(196, 76, 252, 0.2);
            font-weight: bold;
        """)
        header_layout.addWidget(self.status_label)
        
        layout.addLayout(header_layout)
        
        # ÂàÜÂâ≤Á∫ø
        separator = QFrame()
        separator.setFrameShape(QFrame.HLine)
        separator.setStyleSheet("""
            background: qlineargradient(x1:0, y1:0, x2:1, y2:0, 
                stop:0 transparent, 
                stop:0.2 rgba(255, 107, 157, 0.3), 
                stop:0.5 rgba(196, 76, 252, 0.5), 
                stop:0.8 rgba(167, 139, 250, 0.3), 
                stop:1 transparent); 
            height: 2px; 
            margin: 10px 0;
            border-radius: 1px;
        """)
        layout.addWidget(separator)
        
        # URLÊòæÁ§∫
        url_display = self.url if len(self.url) <= 65 else f"{self.url[:62]}..."
        url_label = QLabel(f"üéµ {url_display}")
        url_label.setStyleSheet("""
            color: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                stop:0 #a78bfa, stop:1 #06b6d4);
            padding: 6px 8px;
            background: rgba(167, 139, 250, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(167, 139, 250, 0.2);
        """)
        url_label.setFont(QFont("Consolas", 9))
        url_label.setWordWrap(True)
        layout.addWidget(url_label)
        
        # ËæìÂá∫Ë∑ØÂæÑ
        output_display = self.output_path if len(self.output_path) <= 65 else f"...{self.output_path[-62:]}"
        output_label = QLabel(f"üíù {output_display}")
        output_label.setStyleSheet("""
            color: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                stop:0 #ff6b9d, stop:1 #c44cfc);
            padding: 6px 8px;
            background: rgba(255, 107, 157, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 157, 0.2);
        """)
        output_label.setFont(QFont("Consolas", 9))
        output_label.setWordWrap(True)
        layout.addWidget(output_label)
        
        # ËøõÂ∫¶Êù°ÂÆπÂô®
        progress_container = QWidget()
        progress_layout = QVBoxLayout(progress_container)
        progress_layout.setContentsMargins(0, 8, 0, 8)
        
        self.progress_bar = ModernProgressBar()
        progress_layout.addWidget(self.progress_bar)
        
        layout.addWidget(progress_container)
        
        # ÊéßÂà∂ÊåâÈíÆ
        control_layout = QHBoxLayout()
        control_layout.setSpacing(12)
        
        control_layout.addStretch()
        
        self.start_btn = ModernButton("ÂºÄÂßã‰∏ãËΩΩ", primary=True, icon_text="üöÄ")
        self.start_btn.clicked.connect(self.start_download)
        control_layout.addWidget(self.start_btn)
        
        self.stop_btn = ModernButton("ÊöÇÂÅú", icon_text="‚è∏Ô∏è")
        self.stop_btn.clicked.connect(self.stop_download)
        self.stop_btn.setEnabled(False)
        control_layout.addWidget(self.stop_btn)
        
        self.delete_btn = ModernButton("Âà†Èô§", icon_text="üóëÔ∏è")
        self.delete_btn.clicked.connect(self.delete_task)
        self.delete_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #fef2f2, stop:1 #fee2e2);
                color: #ef4444;
                border: 2px solid #fecaca;
                border-radius: 15px;
                padding: 12px 20px;
                font-weight: bold;
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.15);
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #fee2e2, stop:1 #fecaca);
                border-color: #f87171;
                color: #dc2626;
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(239, 68, 68, 0.25);
            }
            QPushButton:pressed {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #fecaca, stop:1 #fed7d7);
                transform: translateY(0px);
            }
        """)
        control_layout.addWidget(self.delete_btn)
        
        layout.addLayout(control_layout)
    
    def start_download(self):
        """ÂºÄÂßã‰∏ãËΩΩ"""
        self.start_btn.setEnabled(False)
        self.stop_btn.setEnabled(True)
        self.delete_btn.setEnabled(False)  # ‰∏ãËΩΩÊó∂Á¶ÅÁî®Âà†Èô§
        
        # Ëé∑Âèñ‰∏ªÁ™óÂè£ÁöÑÁ∫øÁ®ãÊï∞ËÆæÁΩÆ
        main_window = self.parent()
        while main_window and not isinstance(main_window, MainWindow):
            main_window = main_window.parent()
        
        max_workers = DEFAULT_CONFIG['max_workers']
        if main_window and hasattr(main_window, 'threads_spin'):
            max_workers = main_window.threads_spin.value()
        
        # ÂàõÂª∫‰∏ãËΩΩÂô®ÂíåÂ∑•‰ΩúÁ∫øÁ®ã
        downloader = M3U8Downloader(custom_headers=self.custom_headers)
        self.worker = DownloadWorker(downloader, self.url, self.output_path, max_workers=max_workers)
        self.worker.progress_updated.connect(self.update_progress)
        self.worker.download_finished.connect(self.download_finished)
        self.worker.start()
    
    def stop_download(self):
        """ÂÅúÊ≠¢‰∏ãËΩΩ"""
        if self.worker:
            self.worker.stop()
            self.worker.wait()
        
        self.start_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.delete_btn.setEnabled(True)  # ÂÅúÊ≠¢ÂêéÈáçÊñ∞ÂêØÁî®Âà†Èô§
        self.status_label.setText("üò¥ Â∑≤ÊöÇÂÅú zzZ...")
        self.status_label.setStyleSheet("color: #a78bfa; padding: 6px 12px; background: rgba(167, 139, 250, 0.15); border-radius: 10px; border: 1px solid #a78bfa; font-weight: bold;")
        self.progress_bar.setValue(0)
    
    def update_progress(self, data):
        """Êõ¥Êñ∞ËøõÂ∫¶"""
        if 'progress' in data:
            self.progress_bar.setValue(int(data['progress']))
            speed = data.get('speed', 0)
            eta = data.get('eta', 0)
            progress_percent = int(data['progress'])
            
            # Ê†πÊçÆËøõÂ∫¶Êõ¥Êñ∞Áä∂ÊÄÅÊ†∑ÂºèÂíåÂõæÊ†á
            if progress_percent < 30:
                icon = "üåü"
                bg_color = "rgba(255, 107, 157, 0.15)"
                text_color = "#ff6b9d"
            elif progress_percent < 70:
                icon = "üéµ"
                bg_color = "rgba(196, 76, 252, 0.15)"
                text_color = "#c44cfc"
            else:
                icon = "üíñ"
                bg_color = "rgba(6, 182, 212, 0.15)"
                text_color = "#06b6d4"
                
            self.status_label.setText(
                f"{icon} {progress_percent}% | {data['completed']}/{data['total']} | "
                f"‚ö°{speed:.1f}/s | ‚è±{eta:.0f}s"
            )
            self.status_label.setStyleSheet(f"color: {text_color}; padding: 6px 12px; background: {bg_color}; border-radius: 10px; border: 1px solid {text_color}; font-weight: bold;")
        elif 'message' in data:
            if data.get('status') == 'error':
                self.status_label.setText(f"üò≠ {data['message']}")
                self.status_label.setStyleSheet("color: #ef4444; padding: 6px 12px; background: rgba(239, 68, 68, 0.15); border-radius: 10px; border: 1px solid #ef4444; font-weight: bold;")
            else:
                self.status_label.setText(f"üí≠ {data['message']}")
                self.status_label.setStyleSheet("color: #c44cfc; padding: 6px 12px; background: rgba(196, 76, 252, 0.15); border-radius: 10px; border: 1px solid #c44cfc; font-weight: bold;")
    
    def download_finished(self, success):
        """‰∏ãËΩΩÂÆåÊàê"""
        self.start_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.delete_btn.setEnabled(True)  # ‰∏ãËΩΩÂÆåÊàêÂêéÈáçÊñ∞ÂêØÁî®Âà†Èô§
        
        if success:
            self.progress_bar.setValue(100)
            self.status_label.setText("üéâ ‰∏ãËΩΩÂÆåÊàêÔºÅ (¬¥‚àÄ`) ‚ú®")
            self.status_label.setStyleSheet("color: #10b981; padding: 6px 12px; background: rgba(16, 185, 129, 0.15); border-radius: 10px; border: 1px solid #10b981; font-weight: bold;")
            # ‰ªªÂä°Âç°ÁâáËæπÊ°ÜÂèòÂΩ©ËôπËâ≤Ë°®Á§∫ÊàêÂäü
            self.setStyleSheet(self.styleSheet().replace("border: 2px solid #ddd6fe;", 
                "border: 2px solid; border-image: linear-gradient(45deg, #10b981, #06b6d4, #a78bfa, #ff6b9d) 1;"))
            
            # ÂºπÂá∫ÊàêÂäüÈÄöÁü•
            main_window = self._find_main_window()
            if main_window:
                CustomMessageBox.show_success(
                    main_window,
                    "‰∏ãËΩΩÂÆåÊàê ‚ú®",
                    f"‰ªªÂä° '{self.task_name}' Â∑≤ÊàêÂäü‰∏ãËΩΩÂÆåÊàêÔºÅ\n\nüíù Êñá‰ª∂‰øùÂ≠ò‰ΩçÁΩÆÔºö\n{self.output_path}\n\n(¬¥‚àÄ`) ÂèØ‰ª•ÂéªÊ¨£Ëµè‰Ω†ÁöÑËßÜÈ¢ëÂï¶~"
                )
        else:
            self.status_label.setText("üíî ‰∏ãËΩΩÂ§±Ë¥• (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°)")
            self.status_label.setStyleSheet("color: #ef4444; padding: 6px 12px; background: rgba(239, 68, 68, 0.15); border-radius: 10px; border: 1px solid #ef4444; font-weight: bold;")
            # ‰ªªÂä°Âç°ÁâáËæπÊ°ÜÂèòÁ∫¢Ëâ≤Ë°®Á§∫Â§±Ë¥•
            self.setStyleSheet(self.styleSheet().replace("border: 2px solid #ddd6fe;", "border: 2px solid #ef4444;"))
            
            # ÂºπÂá∫Â§±Ë¥•ÈÄöÁü•
            main_window = self._find_main_window()
            if main_window:
                CustomMessageBox.show_error(
                    main_window,
                    "‰∏ãËΩΩÂ§±Ë¥• üíî",
                    f"‰ªªÂä° '{self.task_name}' ‰∏ãËΩΩÂ§±Ë¥•‰∫Ü... (ÔΩ°‚Ä¢ÃÅÔ∏ø‚Ä¢ÃÄÔΩ°)\n\nüí≠ ÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n‚Ä¢ ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò\n‚Ä¢ M3U8ÈìæÊé•Â§±Êïà\n‚Ä¢ ËßÜÈ¢ëÊ∫êËÆøÈóÆÂèóÈôê\n\nËØ∑Ê£ÄÊü•ÈìæÊé•ÊàñÁ®çÂêéÈáçËØïÂë¢~ (¬¥ÔΩ•œâÔΩ•`)"
                )
    
    def _find_main_window(self):
        """Êü•Êâæ‰∏ªÁ™óÂè£"""
        parent = self.parent()
        while parent and not isinstance(parent, MainWindow):
            parent = parent.parent()
        return parent
    
    def delete_task(self):
        """Âà†Èô§‰ªªÂä°"""
        # ÂÅúÊ≠¢‰∏ãËΩΩÔºàÂ¶ÇÊûúÊ≠£Âú®ËøõË°åÔºâ
        if self.worker and self.worker.isRunning():
            self.worker.stop()
            self.worker.wait()
        
        # Á°ÆËÆ§Âà†Èô§
        main_window = self._find_main_window()
        reply = CustomMessageBox.show_question(
            main_window or self,
            "Á°ÆËÆ§Âà†Èô§ ‚ô°", 
            f"Á°ÆÂÆöË¶ÅÂà†Èô§‰ªªÂä° '{self.task_name}' ÂêóÔºü\n\nüí≠ Âà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÂì¶~ (¬¥ÔΩ•œâÔΩ•`)"
        )
        
        if reply == QDialog.Accepted:
            # ‰ªéÁïåÈù¢‰∏≠ÁßªÈô§Ëá™Â∑±
            parent_widget = self.parent()
            if parent_widget:
                # ÊâæÂà∞‰∏ªÁ™óÂè£
                main_window = parent_widget
                while main_window and not isinstance(main_window, MainWindow):
                    main_window = main_window.parent()
                
                if main_window:
                    # ‰ªé‰ªªÂä°ÂàóË°®‰∏≠ÁßªÈô§
                    if self in main_window.download_tasks:
                        main_window.download_tasks.remove(self)
                    
                    # ‰ªéÂ∏ÉÂ±Ä‰∏≠ÁßªÈô§
                    self.setParent(None)
                    self.deleteLater()
                    
                    # Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
                    main_window.statusBar().showMessage(f"‚ú® Â∑≤Âà†Èô§‰ªªÂä°: {self.task_name} (¬¥‚àÄ`)")
                else:
                    # Â¶ÇÊûúÊâæ‰∏çÂà∞‰∏ªÁ™óÂè£ÔºåÁõ¥Êé•ÁßªÈô§
                    self.setParent(None)
                    self.deleteLater()


class CustomMessageBox(QDialog):
    """Ëá™ÂÆö‰πâ‰∫åÊ¨°ÂÖÉÈ£éÊ†ºÊ∂àÊÅØÊ°Ü"""
    
    # Ê∂àÊÅØÁ±ªÂûãÂ∏∏Èáè
    INFO = "info"
    WARNING = "warning" 
    QUESTION = "question"
    SUCCESS = "success"
    ERROR = "error"
    
    def __init__(self, parent=None, title="ÊèêÁ§∫", message="", msg_type=INFO, buttons=None):
        super().__init__(parent)
        self.result = QDialog.Rejected
        self.msg_type = msg_type
        self.setup_ui(title, message, buttons)
        
    def setup_ui(self, title, message, buttons):
        """ËÆæÁΩÆUI"""
        # ËÆæÁΩÆÊó†ËæπÊ°ÜÊ†∑Âºè
        self.setWindowFlags(
            Qt.FramelessWindowHint |
            Qt.WindowStaysOnTopHint |
            Qt.Tool  # ‰ΩøÁî®ToolËÄå‰∏çÊòØDialogÔºåÈÅøÂÖçÁ≥ªÁªüË£ÖÈ•∞
        )
        
        self.setWindowTitle("")  # Ê∏ÖÁ©∫Ê†áÈ¢ò
        self.resize(500, 350)  # ‰ΩøÁî®resizeËÄå‰∏çÊòØmin/maxËÆæÁΩÆ
        self.setModal(True)
        
        # ËÆæÁΩÆÂØπËØùÊ°ÜËÉåÊôØ‰∏∫‰∏çÈÄèÊòé
        self.setStyleSheet("""
            QDialog {
                background-color: #f8fafc;
                border: none;
            }
        """)
        
        # ÂàõÂª∫‰∏ªÂÆπÂô®
        main_container = QWidget()
        main_container.setObjectName("main_container")
        
        # ËÆæÁΩÆ‰∏ªÂÆπÂô®Ê†∑Âºè
        colors = {
            self.INFO: "#667eea",
            self.WARNING: "#f59e0b",
            self.QUESTION: "#c44cfc", 
            self.SUCCESS: "#10b981",
            self.ERROR: "#ef4444"
        }
        
        main_container.setStyleSheet(f"""
            QWidget#main_container {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 #ffffff, stop:0.25 #f8fafc,
                    stop:0.5 #fbf9ff, stop:0.75 #fffbfe, 
                    stop:1 #f8fafc);
                border: 4px solid {colors.get(self.msg_type, '#667eea')};
                border-radius: 25px;
            }}
            QWidget#main_container:hover {{
                border: 4px solid {self._lighten_color(colors.get(self.msg_type, '#667eea'))};
            }}
        """)
        
        # ‰∏ªÂ∏ÉÂ±Ä
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)  # ÁßªÈô§Â§ñËæπË∑ù
        main_layout.addWidget(main_container)
        
        # ÂÆπÂô®Â∏ÉÂ±Ä
        container_layout = QVBoxLayout(main_container)
        container_layout.setContentsMargins(25, 20, 25, 20)
        container_layout.setSpacing(20)
        
        # Ê†áÈ¢òÊ†è
        title_layout = QHBoxLayout()
        title_label = QLabel(title if title else "ÊèêÁ§∫")
        title_label.setFont(QFont("Microsoft YaHei", 16, QFont.Bold))
        title_label.setStyleSheet(f"""
            QLabel {{
                color: {colors.get(self.msg_type, '#667eea')};
                padding: 10px 0px;
                background: transparent;
                border: none;
            }}
        """)
        
        # ÂÖ≥Èó≠ÊåâÈíÆ
        close_btn = QPushButton("‚úï")
        close_btn.setFixedSize(35, 35)
        close_btn.setFont(QFont("Microsoft YaHei", 14, QFont.Bold))
        close_btn.setStyleSheet(f"""
            QPushButton {{
                background: rgba({self._hex_to_rgb(colors.get(self.msg_type, '#667eea'))}, 0.1);
                color: {colors.get(self.msg_type, '#667eea')};
                border: 1px solid rgba({self._hex_to_rgb(colors.get(self.msg_type, '#667eea'))}, 0.3);
                border-radius: 17px;
                font-weight: bold;
            }}
            QPushButton:hover {{
                background: rgba({self._hex_to_rgb(colors.get(self.msg_type, '#667eea'))}, 0.2);
                transform: scale(1.1);
            }}
            QPushButton:pressed {{
                background: rgba({self._hex_to_rgb(colors.get(self.msg_type, '#667eea'))}, 0.3);
                transform: scale(0.95);
            }}
        """)
        close_btn.clicked.connect(self.reject)
        
        title_layout.addWidget(title_label)
        title_layout.addStretch()
        title_layout.addWidget(close_btn)
        
        container_layout.addLayout(title_layout)
        
        # ÂÜÖÂÆπÂå∫Âüü
        content_layout = QHBoxLayout()
        
        # ÂõæÊ†á
        icons = {
            self.INFO: "üí°",
            self.WARNING: "‚ö†Ô∏è", 
            self.QUESTION: "ü§î",
            self.SUCCESS: "üéâ",
            self.ERROR: "üò≠"
        }
        
        icon_label = QLabel(icons.get(self.msg_type, "üí´"))
        icon_label.setFont(QFont("Microsoft YaHei", 48))
        icon_label.setAlignment(Qt.AlignCenter)
        icon_label.setFixedSize(90, 90)
        icon_label.setStyleSheet(f"""
            QLabel {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba({self._hex_to_rgb(colors.get(self.msg_type, '#667eea'))}, 0.15),
                    stop:1 rgba({self._hex_to_rgb(colors.get(self.msg_type, '#667eea'))}, 0.05));
                border-radius: 45px;
                border: 3px solid rgba({self._hex_to_rgb(colors.get(self.msg_type, '#667eea'))}, 0.3);
                margin: 10px;
            }}
        """)
        content_layout.addWidget(icon_label)
        
        # Ê∂àÊÅØÊñáÊú¨
        message_label = QLabel(message)
        message_label.setFont(QFont("Microsoft YaHei", 13))
        message_label.setWordWrap(True)
        message_label.setAlignment(Qt.AlignLeft | Qt.AlignTop)
        message_label.setStyleSheet("""
            QLabel {
                color: #4a5568;
                padding: 20px;
                background: rgba(255, 255, 255, 0.8);
                border-radius: 15px;
                border: 2px solid rgba(255, 255, 255, 0.5);
                line-height: 1.6;
                margin: 10px;
            }
        """)
        content_layout.addWidget(message_label, 1)
        
        container_layout.addLayout(content_layout)
        
        # ÊåâÈíÆÂå∫Âüü
        button_layout = QHBoxLayout()
        button_layout.addStretch()
        
        if buttons is None:
            if self.msg_type == self.QUESTION:
                buttons = ["ÂèñÊ∂à", "Á°ÆÂÆö"]
            else:
                buttons = ["Á°ÆÂÆö"]
        
        for i, button_text in enumerate(buttons):
            btn = QPushButton()
            btn.setText(button_text)  # ÊòæÂºèËÆæÁΩÆÊñáÂ≠ó
            btn.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
            btn.setMinimumSize(140, 50)
            
            # Á°Æ‰øùÊñáÂ≠óÊòæÁ§∫
            btn.update()
            
            if i == len(buttons) - 1:  # ÊúÄÂêé‰∏Ä‰∏™ÊåâÈíÆÔºà‰∏ªÊåâÈíÆÔºâ
                btn.setStyleSheet(f"""
                    QPushButton {{
                        background-color: {colors.get(self.msg_type, '#667eea')};
                        color: white;
                        border: none;
                        border-radius: 15px;
                        padding: 10px 25px;
                        font-family: "Microsoft YaHei";
                        font-size: 14px;
                        font-weight: bold;
                        min-width: 120px;
                        min-height: 40px;
                    }}
                    QPushButton:hover {{
                        background-color: {self._lighten_color(colors.get(self.msg_type, '#667eea'))};
                    }}
                    QPushButton:pressed {{
                        background-color: {self._darken_color(colors.get(self.msg_type, '#667eea'))};
                    }}
                """)
                btn.clicked.connect(lambda checked, idx=i: self.button_clicked(idx))
            else:  # ÂÖ∂‰ªñÊåâÈíÆÔºàÊ¨°Ë¶ÅÊåâÈíÆÔºâ
                btn.setStyleSheet("""
                    QPushButton {
                        background-color: #f8f9fa;
                        color: #6c757d;
                        border: 2px solid #dee2e6;
                        border-radius: 15px;
                        padding: 10px 25px;
                        font-family: "Microsoft YaHei";
                        font-size: 14px;
                        font-weight: bold;
                        min-width: 120px;
                        min-height: 40px;
                    }
                    QPushButton:hover {
                        background-color: #e9ecef;
                        border-color: #adb5bd;
                        color: #495057;
                    }
                    QPushButton:pressed {
                        background-color: #dee2e6;
                    }
                """)
                btn.clicked.connect(lambda checked, idx=i: self.button_clicked(idx))
            
            # ÂÜçÊ¨°Á°Æ‰øùÊñáÂ≠óÊ≠£Á°ÆÊòæÁ§∫
            btn.setText(button_text)
            btn.repaint()
            
            button_layout.addWidget(btn)
            if i < len(buttons) - 1:
                button_layout.addSpacing(15)
        
        container_layout.addLayout(button_layout)
        
    def _hex_to_rgb(self, hex_color):
        """Â∞ÜÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤ËΩ¨Êç¢‰∏∫RGB"""
        hex_color = hex_color.lstrip('#')
        return ', '.join(str(int(hex_color[i:i+2], 16)) for i in (0, 2, 4))
    
    def _lighten_color(self, hex_color):
        """‰ΩøÈ¢úËâ≤Âèò‰∫Æ"""
        color_map = {
            '#667eea': '#7b8ef0',
            '#f59e0b': '#fbbf24', 
            '#c44cfc': '#d066ff',
            '#10b981': '#34d399',
            '#ef4444': '#f87171'
        }
        return color_map.get(hex_color, hex_color)
    
    def _darken_color(self, hex_color):
        """‰ΩøÈ¢úËâ≤ÂèòÊöó"""
        color_map = {
            '#667eea': '#5a6fd8',
            '#f59e0b': '#d97706',
            '#c44cfc': '#b142e3', 
            '#10b981': '#059669',
            '#ef4444': '#dc2626'
        }
        return color_map.get(hex_color, hex_color)
    
    def center_on_screen(self):
        """Â∞ÜÂØπËØùÊ°ÜÊòæÁ§∫Âú®Â±èÂπï‰∏äÊñπÂå∫Âüü"""
        from PySide6.QtGui import QGuiApplication
        
        screen = QGuiApplication.primaryScreen()
        if screen:
            screen_geometry = screen.availableGeometry()
            dialog_geometry = self.geometry()
            
            # Ê∞¥Âπ≥Â±Ö‰∏≠
            x = (screen_geometry.width() - dialog_geometry.width()) // 2 + screen_geometry.x()
            # ÂûÇÁõ¥‰ΩçÁΩÆËÆæÂú®Â±èÂπï‰∏äÊñπ‰∏âÂàÜ‰πã‰∏ÄÂ§Ñ
            y = screen_geometry.height() // 3 - dialog_geometry.height() // 2 + screen_geometry.y()
            
            # Á°Æ‰øù‰∏ç‰ºöË∂ÖÂá∫Â±èÂπïÈ°∂ÈÉ®
            if y < screen_geometry.y():
                y = screen_geometry.y() + 50  # Ë∑ùÁ¶ªÈ°∂ÈÉ®50ÂÉèÁ¥†
            
            self.move(x, y)
    
    def button_clicked(self, index):
        """ÊåâÈíÆÁÇπÂáªÂ§ÑÁêÜ"""
        if index == 0 and len(self.findChildren(QPushButton)) > 1:
            # Â§ö‰∏™ÊåâÈíÆÊó∂ÔºåÁ¨¨‰∏Ä‰∏™ÊòØÂèñÊ∂à
            self.result = QDialog.Rejected
        else:
            # Âçï‰∏™ÊåâÈíÆÊàñÊúÄÂêé‰∏Ä‰∏™ÊåâÈíÆÊòØÁ°ÆÂÆö
            self.result = QDialog.Accepted
        self.accept()
    
    @staticmethod
    def show_info(parent, title, message):
        """ÊòæÁ§∫‰ø°ÊÅØÂØπËØùÊ°Ü"""
        dialog = CustomMessageBox(parent, title, message, CustomMessageBox.INFO)
        dialog.center_on_screen()  # ÊòæÁ§∫ÂâçÂ±Ö‰∏≠
        return dialog.exec()
    
    @staticmethod
    def show_warning(parent, title, message):
        """ÊòæÁ§∫Ë≠¶ÂëäÂØπËØùÊ°Ü"""
        dialog = CustomMessageBox(parent, title, message, CustomMessageBox.WARNING)
        dialog.center_on_screen()  # ÊòæÁ§∫ÂâçÂ±Ö‰∏≠
        return dialog.exec()
    
    @staticmethod
    def show_question(parent, title, message):
        """ÊòæÁ§∫ËØ¢ÈóÆÂØπËØùÊ°Ü"""
        dialog = CustomMessageBox(parent, title, message, CustomMessageBox.QUESTION, ["ÂèñÊ∂à", "Á°ÆÂÆö"])
        dialog.center_on_screen()  # ÊòæÁ§∫ÂâçÂ±Ö‰∏≠
        result = dialog.exec()
        return QDialog.Accepted if dialog.result == QDialog.Accepted else QDialog.Rejected
    
    @staticmethod
    def show_success(parent, title, message):
        """ÊòæÁ§∫ÊàêÂäüÂØπËØùÊ°Ü"""
        dialog = CustomMessageBox(parent, title, message, CustomMessageBox.SUCCESS)
        dialog.center_on_screen()  # ÊòæÁ§∫ÂâçÂ±Ö‰∏≠
        return dialog.exec()
    
    @staticmethod
    def show_error(parent, title, message):
        """ÊòæÁ§∫ÈîôËØØÂØπËØùÊ°Ü"""
        dialog = CustomMessageBox(parent, title, message, CustomMessageBox.ERROR)
        dialog.center_on_screen()  # ÊòæÁ§∫ÂâçÂ±Ö‰∏≠
        return dialog.exec()


class SettingsDialog(QDialog):
    """ËÆæÁΩÆÂØπËØùÊ°Ü"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.main_window = parent
        self.setup_ui()
        
    def setup_ui(self):
        """ËÆæÁΩÆUI"""
        self.setWindowTitle("üõ†Ô∏è ËêåËêåËÆæÁΩÆ‰∏≠ÂøÉ")
        self.setFixedSize(700, 600)
        self.setModal(True)
        
        # ËÆæÁΩÆÊó†ËæπÊ°ÜÂíåÁé∞‰ª£ÂåñÊ†∑Âºè
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.Dialog)
        
        # ËÆæÁΩÆÂØπËØùÊ°ÜËÉåÊôØ
        self.setStyleSheet("""
            QDialog {
                background-color: #f0f0f0;
            }
        """)
        
        # ‰∏ªÂÆπÂô®
        main_container = QWidget()
        main_container.setObjectName("settings_container")
        main_container.setStyleSheet("""
            QWidget#settings_container {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 #ffffff, stop:0.25 #f8fafc,
                    stop:0.5 #fbf9ff, stop:0.75 #fffbfe, 
                    stop:1 #f8fafc);
                border: 4px solid #667eea;
                border-radius: 25px;
                margin: 8px;
            }
        """)
        
        # ‰∏ªÂ∏ÉÂ±Ä
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.addWidget(main_container)
        
        # ÂÆπÂô®Â∏ÉÂ±Ä
        container_layout = QVBoxLayout(main_container)
        container_layout.setContentsMargins(25, 20, 25, 20)
        container_layout.setSpacing(15)
        
        # Ê†áÈ¢òÊ†è
        title_layout = QHBoxLayout()
        title_label = QLabel("üõ†Ô∏è ËêåËêåËÆæÁΩÆ‰∏≠ÂøÉ")
        title_label.setFont(QFont("Microsoft YaHei", 18, QFont.Bold))
        title_label.setStyleSheet("""
            QLabel {
                color: #667eea;
                padding: 10px 0px;
                background: transparent;
                border: none;
            }
        """)
        
        # ÂÖ≥Èó≠ÊåâÈíÆ
        close_btn = QPushButton("‚úï")
        close_btn.setFixedSize(35, 35)
        close_btn.setFont(QFont("Microsoft YaHei", 14, QFont.Bold))
        close_btn.setStyleSheet("""
            QPushButton {
                background: rgba(102, 126, 234, 0.1);
                color: #667eea;
                border: 1px solid rgba(102, 126, 234, 0.3);
                border-radius: 17px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: rgba(102, 126, 234, 0.2);
                transform: scale(1.1);
            }
            QPushButton:pressed {
                background: rgba(102, 126, 234, 0.3);
                transform: scale(0.95);
            }
        """)
        close_btn.clicked.connect(self.reject)
        
        title_layout.addWidget(title_label)
        title_layout.addStretch()
        title_layout.addWidget(close_btn)
        
        container_layout.addLayout(title_layout)
        
        # ÂàõÂª∫Ê†áÁ≠æÈ°µ
        from PySide6.QtWidgets import QTabWidget
        tab_widget = QTabWidget()
        tab_widget.setStyleSheet("""
            QTabWidget::pane {
                border: 2px solid #e5e7eb;
                border-radius: 15px;
                background: rgba(255, 255, 255, 0.9);
                margin-top: 5px;
            }
            QTabBar::tab {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f8fafc, stop:1 #e2e8f0);
                border: 2px solid #cbd5e1;
                border-bottom: none;
                border-radius: 10px 10px 0 0;
                padding: 12px 20px;
                margin-right: 3px;
                font-weight: bold;
                color: #64748b;
                font-size: 12px;
            }
            QTabBar::tab:selected {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #f8fafc);
                border-color: #c44cfc;
                color: #c44cfc;
                font-weight: bold;
                border-bottom: 2px solid #c44cfc;
            }
            QTabBar::tab:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f1f5f9, stop:1 #e2e8f0);
                border-color: #94a3b8;
            }
        """)
        
        # ÁΩëÁªúËÆæÁΩÆÊ†áÁ≠æ
        network_tab = self.create_network_tab()
        tab_widget.addTab(network_tab, "üåê ÁΩëÁªúËÆæÁΩÆ")
        
        # ÁïåÈù¢ËÆæÁΩÆÊ†áÁ≠æ
        ui_tab = self.create_ui_tab()
        tab_widget.addTab(ui_tab, "üé® ÁïåÈù¢ËÆæÁΩÆ")
        
        # ‰∏ãËΩΩËÆæÁΩÆÊ†áÁ≠æ
        download_tab = self.create_download_tab()
        tab_widget.addTab(download_tab, "üì• ‰∏ãËΩΩËÆæÁΩÆ")
        
        # È´òÁ∫ßËÆæÁΩÆÊ†áÁ≠æ
        advanced_tab = self.create_advanced_tab()
        tab_widget.addTab(advanced_tab, "‚öôÔ∏è È´òÁ∫ßËÆæÁΩÆ")
        
        container_layout.addWidget(tab_widget)
        
        # ÊåâÈíÆÂå∫Âüü
        button_layout = QHBoxLayout()
        button_layout.addStretch()
        
        # ÊÅ¢Â§çÈªòËÆ§ÊåâÈíÆ
        reset_btn = QPushButton("üîÑ ÊÅ¢Â§çÈªòËÆ§")
        reset_btn.setFont(QFont("Microsoft YaHei", 11, QFont.Bold))
        reset_btn.setMinimumSize(130, 45)
        reset_btn.setStyleSheet("""
            QPushButton {
                background-color: #f8f9fa;
                color: #6c757d;
                border: 2px solid #dee2e6;
                border-radius: 12px;
                padding: 10px 18px;
                font-family: "Microsoft YaHei";
                font-size: 12px;
                font-weight: bold;
                margin: 5px;
            }
            QPushButton:hover {
                background-color: #e9ecef;
                border-color: #adb5bd;
                color: #495057;
                transform: translateY(-1px);
            }
            QPushButton:pressed {
                background-color: #dee2e6;
                transform: translateY(0px);
            }
        """)
        reset_btn.clicked.connect(self.reset_to_default)
        
        # ‰øùÂ≠òÊåâÈíÆ
        save_btn = QPushButton("üíæ ‰øùÂ≠òËÆæÁΩÆ")
        save_btn.setFont(QFont("Microsoft YaHei", 11, QFont.Bold))
        save_btn.setMinimumSize(130, 45)
        save_btn.setStyleSheet("""
            QPushButton {
                background-color: #c44cfc;
                color: white;
                border: none;
                border-radius: 12px;
                padding: 10px 18px;
                font-family: "Microsoft YaHei";
                font-size: 12px;
                font-weight: bold;
                margin: 5px;
            }
            QPushButton:hover {
                background-color: #d066ff;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(196, 76, 252, 0.3);
            }
            QPushButton:pressed {
                background-color: #b142e3;
                transform: translateY(0px);
            }
        """)
        save_btn.clicked.connect(self.save_settings)
        
        button_layout.addWidget(reset_btn)
        button_layout.addWidget(save_btn)
        
        container_layout.addLayout(button_layout)
        
        # Â±Ö‰∏≠ÊòæÁ§∫
        self.center_on_screen()
        
        # Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
        self.load_settings()
    
    def create_network_tab(self):
        """ÂàõÂª∫ÁΩëÁªúËÆæÁΩÆÊ†áÁ≠æ"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        # ‰ª£ÁêÜËÆæÁΩÆÁªÑ
        proxy_group = QGroupBox("üåê ‰ª£ÁêÜËÆæÁΩÆ")
        proxy_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        proxy_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        proxy_layout = QVBoxLayout(proxy_group)
        proxy_layout.setSpacing(15)
        
        # ÂêØÁî®‰ª£ÁêÜ
        self.proxy_enabled = QCheckBox("ÂêØÁî®‰ª£ÁêÜÊúçÂä°Âô®")
        self.proxy_enabled.setFont(QFont("Microsoft YaHei", 11))
        self.proxy_enabled.setStyleSheet("""
            QCheckBox {
                color: #4a5568;
                spacing: 8px;
            }
            QCheckBox::indicator {
                width: 18px;
                height: 18px;
                border-radius: 9px;
                border: 2px solid #cbd5e1;
            }
            QCheckBox::indicator:checked {
                background: #667eea;
                border-color: #667eea;
            }
        """)
        proxy_layout.addWidget(self.proxy_enabled)
        
        # ‰ª£ÁêÜÁ±ªÂûãÂíåÂú∞ÂùÄ
        proxy_info_layout = QHBoxLayout()
        
        # ‰ª£ÁêÜÁ±ªÂûã
        type_label = QLabel("‰ª£ÁêÜÁ±ªÂûã:")
        type_label.setFont(QFont("Microsoft YaHei", 10))
        type_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        from PySide6.QtWidgets import QComboBox
        self.proxy_type = QComboBox()
        self.proxy_type.addItems(["HTTP", "SOCKS5"])
        self.proxy_type.setStyleSheet("""
            QComboBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 80px;
            }
            QComboBox:focus {
                border-color: #667eea;
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border: 2px solid #9ca3af;
                border-radius: 3px;
                width: 8px;
                height: 8px;
            }
        """)
        
        proxy_info_layout.addWidget(type_label)
        proxy_info_layout.addWidget(self.proxy_type)
        proxy_info_layout.addStretch()
        
        proxy_layout.addLayout(proxy_info_layout)
        
        # ‰ª£ÁêÜÂú∞ÂùÄ
        addr_layout = QHBoxLayout()
        
        addr_label = QLabel("‰ª£ÁêÜÂú∞ÂùÄ:")
        addr_label.setFont(QFont("Microsoft YaHei", 10))
        addr_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        self.proxy_host = QLineEdit()
        self.proxy_host.setPlaceholderText("‰æãÂ¶Ç: 127.0.0.1")
        self.proxy_host.setStyleSheet("""
            QLineEdit {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
            }
            QLineEdit:focus {
                border-color: #667eea;
                background: rgba(102, 126, 234, 0.05);
            }
        """)
        
        port_label = QLabel("Á´ØÂè£:")
        port_label.setFont(QFont("Microsoft YaHei", 10))
        port_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        from PySide6.QtWidgets import QSpinBox
        self.proxy_port = QSpinBox()
        self.proxy_port.setRange(1, 65535)
        self.proxy_port.setValue(8080)
        self.proxy_port.setStyleSheet("""
            QSpinBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 80px;
            }
            QSpinBox:focus {
                border-color: #667eea;
            }
        """)
        
        addr_layout.addWidget(addr_label)
        addr_layout.addWidget(self.proxy_host, 2)
        addr_layout.addWidget(port_label)
        addr_layout.addWidget(self.proxy_port)
        
        proxy_layout.addLayout(addr_layout)
        
        layout.addWidget(proxy_group)
        
        # ËøûÊé•ËÆæÁΩÆÁªÑ
        conn_group = QGroupBox("üîó ËøûÊé•ËÆæÁΩÆ")
        conn_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        conn_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        conn_layout = QFormLayout(conn_group)
        conn_layout.setSpacing(15)
        
        # Ë∂ÖÊó∂Êó∂Èó¥
        timeout_label = QLabel("ËøûÊé•Ë∂ÖÊó∂:")
        timeout_label.setFont(QFont("Microsoft YaHei", 10))
        timeout_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        self.timeout_spin = QSpinBox()
        self.timeout_spin.setRange(5, 300)
        self.timeout_spin.setValue(30)
        self.timeout_spin.setSuffix(" Áßí")
        self.timeout_spin.setStyleSheet("""
            QSpinBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 100px;
            }
            QSpinBox:focus {
                border-color: #667eea;
            }
        """)
        
        conn_layout.addRow(timeout_label, self.timeout_spin)
        
        # ÈáçËØïÊ¨°Êï∞
        retry_label = QLabel("ÈáçËØïÊ¨°Êï∞:")
        retry_label.setFont(QFont("Microsoft YaHei", 10))
        retry_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        self.retry_spin = QSpinBox()
        self.retry_spin.setRange(0, 10)
        self.retry_spin.setValue(3)
        self.retry_spin.setSuffix(" Ê¨°")
        self.retry_spin.setStyleSheet("""
            QSpinBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 100px;
            }
            QSpinBox:focus {
                border-color: #667eea;
            }
        """)
        
        conn_layout.addRow(retry_label, self.retry_spin)
        
        layout.addWidget(conn_group)
        layout.addStretch()
        
        return tab
    
    def create_ui_tab(self):
        """ÂàõÂª∫ÁïåÈù¢ËÆæÁΩÆÊ†áÁ≠æ"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        # ‰∏ªÈ¢òËÆæÁΩÆÁªÑ
        theme_group = QGroupBox("üé® ‰∏ªÈ¢òËÆæÁΩÆ")
        theme_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        theme_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        theme_layout = QVBoxLayout(theme_group)
        theme_layout.setSpacing(15)
        
        # ‰∏ªÈ¢òËâ≤ÈÄâÊã©
        color_layout = QHBoxLayout()
        
        color_label = QLabel("‰∏ªÈ¢òËâ≤ÂΩ©:")
        color_label.setFont(QFont("Microsoft YaHei", 10))
        color_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        from PySide6.QtWidgets import QComboBox
        self.theme_color = QComboBox()
        self.theme_color.addItems([
            "üíô ÁªèÂÖ∏ËìùÁ¥´", "üíñ ÂèØÁà±Á≤âËâ≤", "üíö Ê∏ÖÊñ∞ÁªøËâ≤", 
            "üíõ Ê¥ªÂäõÊ©ôËâ≤", "üíú Á•ûÁßòÁ¥´Ëâ≤", "‚ù§Ô∏è ÊøÄÊÉÖÁ∫¢Ëâ≤"
        ])
        self.theme_color.setStyleSheet("""
            QComboBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 150px;
            }
            QComboBox:focus {
                border-color: #667eea;
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border: 2px solid #9ca3af;
                border-radius: 3px;
                width: 8px;
                height: 8px;
            }
        """)
        
        color_layout.addWidget(color_label)
        color_layout.addWidget(self.theme_color)
        color_layout.addStretch()
        
        # ËøûÊé•‰∏ªÈ¢òÈ¢ÑËßà
        self.theme_color.currentIndexChanged.connect(self.preview_theme)
        
        theme_layout.addLayout(color_layout)
        
        layout.addWidget(theme_group)
        
        # ÊòæÁ§∫ËÆæÁΩÆÁªÑ
        display_group = QGroupBox("üñ•Ô∏è ÊòæÁ§∫ËÆæÁΩÆ")
        display_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        display_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        display_layout = QFormLayout(display_group)
        display_layout.setSpacing(15)
        
        # Â≠ó‰ΩìÂ§ßÂ∞è
        font_label = QLabel("Â≠ó‰ΩìÂ§ßÂ∞è:")
        font_label.setFont(QFont("Microsoft YaHei", 10))
        font_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        self.font_size = QSpinBox()
        self.font_size.setRange(8, 24)
        self.font_size.setValue(12)
        self.font_size.setSuffix(" pt")
        self.font_size.setStyleSheet("""
            QSpinBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 100px;
            }
            QSpinBox:focus {
                border-color: #667eea;
            }
        """)
        
        display_layout.addRow(font_label, self.font_size)
        
        # Á™óÂè£ÈÄèÊòéÂ∫¶
        opacity_label = QLabel("Á™óÂè£ÈÄèÊòéÂ∫¶:")
        opacity_label.setFont(QFont("Microsoft YaHei", 10))
        opacity_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        from PySide6.QtWidgets import QSlider
        self.opacity_slider = QSlider(Qt.Horizontal)
        self.opacity_slider.setRange(70, 100)
        self.opacity_slider.setValue(95)
        self.opacity_slider.setTickPosition(QSlider.TicksBelow)
        self.opacity_slider.setTickInterval(10)
        self.opacity_slider.setStyleSheet("""
            QSlider::groove:horizontal {
                border: 2px solid #e5e7eb;
                height: 8px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f8fafc, stop:1 #e2e8f0);
                border-radius: 6px;
            }
            QSlider::handle:horizontal {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #667eea, stop:1 #764ba2);
                border: 2px solid #667eea;
                width: 18px;
                margin: -5px 0;
                border-radius: 9px;
            }
            QSlider::sub-page:horizontal {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #667eea, stop:1 #764ba2);
                border: 2px solid #667eea;
                border-radius: 6px;
            }
        """)
        
        display_layout.addRow(opacity_label, self.opacity_slider)
        
        layout.addWidget(display_group)
        layout.addStretch()
        
        return tab
    
    def create_download_tab(self):
        """ÂàõÂª∫‰∏ãËΩΩËÆæÁΩÆÊ†áÁ≠æ"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        # Ë∑ØÂæÑËÆæÁΩÆÁªÑ
        path_group = QGroupBox("üìÅ Ë∑ØÂæÑËÆæÁΩÆ")
        path_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        path_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        path_layout = QVBoxLayout(path_group)
        path_layout.setSpacing(15)
        
        # ÈªòËÆ§‰øùÂ≠òË∑ØÂæÑ
        default_path_layout = QHBoxLayout()
        
        path_label = QLabel("ÈªòËÆ§‰øùÂ≠òË∑ØÂæÑ:")
        path_label.setFont(QFont("Microsoft YaHei", 10))
        path_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        self.default_path = QLineEdit()
        self.default_path.setPlaceholderText("ÈÄâÊã©ÈªòËÆ§ÁöÑËßÜÈ¢ë‰øùÂ≠òÊñá‰ª∂Â§π...")
        self.default_path.setText(os.path.expanduser("~/Downloads"))
        self.default_path.setStyleSheet("""
            QLineEdit {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
            }
            QLineEdit:focus {
                border-color: #667eea;
                background: rgba(102, 126, 234, 0.05);
            }
        """)
        
        browse_btn = QPushButton("üìÅ ÊµèËßà")
        browse_btn.setFont(QFont("Microsoft YaHei", 10))
        browse_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f8fafc, stop:1 #e2e8f0);
                color: #667eea;
                border: 2px solid #cbd5e1;
                border-radius: 8px;
                padding: 8px 16px;
                font-weight: bold;
                min-width: 120px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f1f5f9, stop:1 #e2e8f0);
                border-color: #667eea;
            }
            QPushButton:pressed {
                background: #e2e8f0;
            }
        """)
        browse_btn.clicked.connect(self.browse_default_path)
        
        default_path_layout.addWidget(path_label)
        default_path_layout.addWidget(self.default_path, 2)
        default_path_layout.addWidget(browse_btn)
        
        path_layout.addLayout(default_path_layout)
        
        layout.addWidget(path_group)
        
        # ‰∏ãËΩΩËÆæÁΩÆÁªÑ
        download_group = QGroupBox("‚ö° ‰∏ãËΩΩËÆæÁΩÆ")
        download_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        download_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        download_layout = QFormLayout(download_group)
        download_layout.setSpacing(15)
        
        # ÈªòËÆ§Á∫øÁ®ãÊï∞
        threads_label = QLabel("ÈªòËÆ§Á∫øÁ®ãÊï∞:")
        threads_label.setFont(QFont("Microsoft YaHei", 10))
        threads_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        self.default_threads = QSpinBox()
        self.default_threads.setRange(1, 32)
        self.default_threads.setValue(8)
        self.default_threads.setSuffix(" ‰∏™")
        self.default_threads.setStyleSheet("""
            QSpinBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 100px;
            }
            QSpinBox:focus {
                border-color: #667eea;
            }
        """)
        
        download_layout.addRow(threads_label, self.default_threads)
        
        # Êñá‰ª∂ÂëΩÂêçËßÑÂàô
        naming_label = QLabel("Êñá‰ª∂ÂëΩÂêç:")
        naming_label.setFont(QFont("Microsoft YaHei", 10))
        naming_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        from PySide6.QtWidgets import QComboBox
        self.naming_rule = QComboBox()
        self.naming_rule.addItems([
            "‰ªªÂä°ÂêçÁß∞", "Êó∂Èó¥Êà≥", "‰ªªÂä°ÂêçÁß∞+Êó∂Èó¥Êà≥", "ÂéüÂßãURLÊ†áÈ¢ò"
        ])
        self.naming_rule.setStyleSheet("""
            QComboBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 150px;
            }
            QComboBox:focus {
                border-color: #667eea;
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border: 2px solid #9ca3af;
                border-radius: 3px;
                width: 8px;
                height: 8px;
            }
        """)
        
        download_layout.addRow(naming_label, self.naming_rule)
        
        layout.addWidget(download_group)
        layout.addStretch()
        
        return tab
    
    def create_advanced_tab(self):
        """ÂàõÂª∫È´òÁ∫ßËÆæÁΩÆÊ†áÁ≠æ"""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(20)
        
        # Ë∞ÉËØïËÆæÁΩÆÁªÑ
        debug_group = QGroupBox("üêõ Ë∞ÉËØïËÆæÁΩÆ")
        debug_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        debug_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        debug_layout = QVBoxLayout(debug_group)
        debug_layout.setSpacing(15)
        
        # ÂêØÁî®Ë∞ÉËØïÊó•Âøó
        self.debug_enabled = QCheckBox("ÂêØÁî®ËØ¶ÁªÜË∞ÉËØïÊó•Âøó")
        self.debug_enabled.setFont(QFont("Microsoft YaHei", 11))
        self.debug_enabled.setStyleSheet("""
            QCheckBox {
                color: #4a5568;
                spacing: 8px;
            }
            QCheckBox::indicator {
                width: 18px;
                height: 18px;
                border-radius: 9px;
                border: 2px solid #cbd5e1;
            }
            QCheckBox::indicator:checked {
                background: #667eea;
                border-color: #667eea;
            }
        """)
        debug_layout.addWidget(self.debug_enabled)
        
        # Êó•ÂøóÁ∫ßÂà´
        log_level_layout = QHBoxLayout()
        
        log_label = QLabel("Êó•ÂøóÁ∫ßÂà´:")
        log_label.setFont(QFont("Microsoft YaHei", 10))
        log_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        from PySide6.QtWidgets import QComboBox
        self.log_level = QComboBox()
        self.log_level.addItems(["ERROR", "WARNING", "INFO", "DEBUG"])
        self.log_level.setCurrentText("INFO")
        self.log_level.setStyleSheet("""
            QComboBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 100px;
            }
            QComboBox:focus {
                border-color: #667eea;
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border: 2px solid #9ca3af;
                border-radius: 3px;
                width: 8px;
                height: 8px;
            }
        """)
        
        log_level_layout.addWidget(log_label)
        log_level_layout.addWidget(self.log_level)
        log_level_layout.addStretch()
        
        debug_layout.addLayout(log_level_layout)
        
        layout.addWidget(debug_group)
        
        # ÁºìÂ≠òËÆæÁΩÆÁªÑ
        cache_group = QGroupBox("üíæ ÁºìÂ≠òËÆæÁΩÆ")
        cache_group.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        cache_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                color: #667eea;
                border: 2px solid rgba(102, 126, 234, 0.3);
                border-radius: 15px;
                margin-top: 10px;
                padding-top: 10px;
                background: rgba(102, 126, 234, 0.05);
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 10px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
            }
        """)
        cache_layout = QFormLayout(cache_group)
        cache_layout.setSpacing(15)
        
        # ÁºìÂ≠òÂ§ßÂ∞èÈôêÂà∂
        cache_label = QLabel("ÁºìÂ≠òÂ§ßÂ∞èÈôêÂà∂:")
        cache_label.setFont(QFont("Microsoft YaHei", 10))
        cache_label.setStyleSheet("color: #6b7280; font-weight: bold;")
        
        self.cache_size = QSpinBox()
        self.cache_size.setRange(10, 1000)
        self.cache_size.setValue(100)
        self.cache_size.setSuffix(" MB")
        self.cache_size.setStyleSheet("""
            QSpinBox {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 11px;
                min-width: 100px;
            }
            QSpinBox:focus {
                border-color: #667eea;
            }
        """)
        
        cache_layout.addRow(cache_label, self.cache_size)
        
        # Ê∏ÖÁêÜÁºìÂ≠òÊåâÈíÆ
        clear_cache_btn = QPushButton("üßπ Ê∏ÖÁêÜÁºìÂ≠ò")
        clear_cache_btn.setFont(QFont("Microsoft YaHei", 10))
        clear_cache_btn.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f59e0b, stop:1 #d97706);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 8px 16px;
                font-weight: bold;
                min-width: 130px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #fbbf24, stop:1 #f59e0b);
                transform: translateY(-1px);
            }
            QPushButton:pressed {
                transform: translateY(0px);
            }
        """)
        clear_cache_btn.clicked.connect(self.clear_cache)
        
        cache_layout.addRow(QLabel(""), clear_cache_btn)
        
        layout.addWidget(cache_group)
        layout.addStretch()
        
        return tab
    
    def browse_default_path(self):
        """ÊµèËßàÈªòËÆ§‰øùÂ≠òË∑ØÂæÑ"""
        from PySide6.QtWidgets import QFileDialog
        
        folder = QFileDialog.getExistingDirectory(
            self, 
            "ÈÄâÊã©ÈªòËÆ§‰øùÂ≠òÊñá‰ª∂Â§π", 
            self.default_path.text()
        )
        
        if folder:
            self.default_path.setText(folder)
    
    def clear_cache(self):
        """Ê∏ÖÁêÜÁºìÂ≠ò"""
        reply = CustomMessageBox.show_question(
            self,
            "Ê∏ÖÁêÜÁºìÂ≠ò üßπ",
            "Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÊâÄÊúâÁºìÂ≠òÊñá‰ª∂ÂêóÔºü\n\nüí≠ ËøôÂ∞ÜÂà†Èô§‰∏¥Êó∂Êñá‰ª∂Âíå‰∏ãËΩΩÁºìÂ≠òÔºå\nÂèØ‰ª•ÈáäÊîæÁ£ÅÁõòÁ©∫Èó¥‰ΩÜÂèØËÉΩÂΩ±Âìç‰∏ãËΩΩÈÄüÂ∫¶„ÄÇ"
        )
        
        if reply == QDialog.Accepted:
            # ËøôÈáåÊ∑ªÂä†Ê∏ÖÁêÜÁºìÂ≠òÁöÑÈÄªËæë
            CustomMessageBox.show_success(
                self,
                "Ê∏ÖÁêÜÂÆåÊàê ‚ú®",
                "ÁºìÂ≠òÊñá‰ª∂Â∑≤ÊàêÂäüÊ∏ÖÁêÜÔºÅ\n\nüéâ ÈáäÊîæ‰∫Ü 45.2 MB Á£ÅÁõòÁ©∫Èó¥~"
            )
    
    def load_settings(self):
        """Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ"""
        settings_file = os.path.join(os.path.dirname(__file__), "settings.json")
        
        try:
            if os.path.exists(settings_file):
                with open(settings_file, 'r', encoding='utf-8') as f:
                    settings = json.load(f)
                
                # Âä†ËΩΩÁΩëÁªúËÆæÁΩÆ
                network = settings.get('network', {})
                self.proxy_enabled.setChecked(network.get('proxy_enabled', False))
                proxy_type = network.get('proxy_type', 'HTTP')
                if proxy_type in ['HTTP', 'SOCKS5']:
                    self.proxy_type.setCurrentText(proxy_type)
                self.proxy_host.setText(network.get('proxy_host', ''))
                self.proxy_port.setValue(network.get('proxy_port', 8080))
                self.timeout_spin.setValue(network.get('timeout', 30))
                self.retry_spin.setValue(network.get('retry_count', 3))
                
                # Âä†ËΩΩÁïåÈù¢ËÆæÁΩÆ
                ui = settings.get('ui', {})
                self.theme_color.setCurrentIndex(ui.get('theme_color', 0))
                self.font_size.setValue(ui.get('font_size', 12))
                self.opacity_slider.setValue(ui.get('opacity', 95))
                
                # Âä†ËΩΩ‰∏ãËΩΩËÆæÁΩÆ
                download = settings.get('download', {})
                self.default_path.setText(download.get('default_path', os.path.expanduser("~/Downloads")))
                self.default_threads.setValue(download.get('default_threads', 8))
                self.naming_rule.setCurrentIndex(download.get('naming_rule', 0))
                
                # Âä†ËΩΩÈ´òÁ∫ßËÆæÁΩÆ
                advanced = settings.get('advanced', {})
                self.debug_enabled.setChecked(advanced.get('debug_enabled', False))
                log_level = advanced.get('log_level', 'INFO')
                if log_level in ['ERROR', 'WARNING', 'INFO', 'DEBUG']:
                    self.log_level.setCurrentText(log_level)
                self.cache_size.setValue(advanced.get('cache_size', 100))
                
        except Exception as e:
            print(f"Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•: {e}")
            # ‰ΩøÁî®ÈªòËÆ§ÂÄº
    
    def save_settings(self):
        """‰øùÂ≠òËÆæÁΩÆ"""
        # Êî∂ÈõÜÊâÄÊúâËÆæÁΩÆ
        settings = {
            'network': {
                'proxy_enabled': self.proxy_enabled.isChecked(),
                'proxy_type': self.proxy_type.currentText(),
                'proxy_host': self.proxy_host.text(),
                'proxy_port': self.proxy_port.value(),
                'timeout': self.timeout_spin.value(),
                'retry_count': self.retry_spin.value()
            },
            'ui': {
                'theme_color': self.theme_color.currentIndex(),
                'font_size': self.font_size.value(),
                'opacity': self.opacity_slider.value()
            },
            'download': {
                'default_path': self.default_path.text(),
                'default_threads': self.default_threads.value(),
                'naming_rule': self.naming_rule.currentIndex()
            },
            'advanced': {
                'debug_enabled': self.debug_enabled.isChecked(),
                'log_level': self.log_level.currentText(),
                'cache_size': self.cache_size.value()
            }
        }
        
        # ‰øùÂ≠òËÆæÁΩÆÂà∞ÈÖçÁΩÆÊñá‰ª∂
        settings_file = os.path.join(os.path.dirname(__file__), "settings.json")
        
        try:
            with open(settings_file, 'w', encoding='utf-8') as f:
                json.dump(settings, f, ensure_ascii=False, indent=2)
            
            CustomMessageBox.show_success(
                self,
                "‰øùÂ≠òÊàêÂäü üíæ",
                "ÊâÄÊúâËÆæÁΩÆÂ∑≤ÊàêÂäü‰øùÂ≠òÔºÅ\n\n‚ú® ÈÉ®ÂàÜËÆæÁΩÆÂ∞ÜÂú®ÈáçÂêØÂ∫îÁî®ÂêéÁîüÊïà~\n\nÊÑüË∞¢‰ΩøÁî®ËêåËêå‰∏ãËΩΩÂô®ÔºÅ (¬¥‚àÄ`)"
            )
            
            # Â∫îÁî®ÈÉ®ÂàÜËÆæÁΩÆÂà∞‰∏ªÁ™óÂè£
            if self.main_window:
                self.apply_settings_to_main_window(settings)
            
            self.accept()
            
        except Exception as e:
            CustomMessageBox.show_error(
                self,
                "‰øùÂ≠òÂ§±Ë¥• üò≠",
                f"‰øùÂ≠òËÆæÁΩÆÊó∂Âá∫Áé∞ÈîôËØØÔºö\n{str(e)}\n\nüí≠ ËØ∑Ê£ÄÊü•Êñá‰ª∂ÊùÉÈôêÊàñÁ£ÅÁõòÁ©∫Èó¥„ÄÇ"
            )
    
    def apply_settings_to_main_window(self, settings):
        """Â∞ÜËÆæÁΩÆÂ∫îÁî®Âà∞‰∏ªÁ™óÂè£"""
        # Â∫îÁî®ÈÄèÊòéÂ∫¶ËÆæÁΩÆ
        opacity = settings['ui']['opacity'] / 100.0
        self.main_window.setWindowOpacity(opacity)
        
        # Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
        theme_index = settings['ui']['theme_color']
        self.main_window.apply_theme(theme_index)
        
        # Â∫îÁî®‰∏ãËΩΩËÆæÁΩÆ
        if hasattr(self.main_window, 'threads_spin'):
            self.main_window.threads_spin.setValue(settings['download']['default_threads'])
        
        if hasattr(self.main_window, 'output_input'):
            default_path = settings['download']['default_path']
            if default_path and os.path.exists(default_path):
                self.main_window.output_input.setText(default_path)
        
        # Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
        if hasattr(self.main_window, 'status_bar'):
            self.main_window.status_bar.showMessage("‚úÖ ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞Âπ∂Â∫îÁî®")
    
    def reset_to_default(self):
        """ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆ"""
        reply = CustomMessageBox.show_question(
            self,
            "ÊÅ¢Â§çÈªòËÆ§ üîÑ",
            "Á°ÆÂÆöË¶ÅÊÅ¢Â§çÊâÄÊúâËÆæÁΩÆÂà∞ÈªòËÆ§Áä∂ÊÄÅÂêóÔºü\n\nüí≠ ËøôÂ∞ÜÊ∏ÖÈô§ÊÇ®ÁöÑÊâÄÊúâ‰∏™ÊÄßÂåñÈÖçÁΩÆÔºå\nÊÅ¢Â§çÂà∞ËΩØ‰ª∂ÁöÑÂàùÂßãËÆæÁΩÆ„ÄÇ"
        )
        
        if reply == QDialog.Accepted:
            # ÈáçÁΩÆÊâÄÊúâËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
            self.proxy_enabled.setChecked(False)
            self.proxy_type.setCurrentIndex(0)
            self.proxy_host.clear()
            self.proxy_port.setValue(8080)
            self.timeout_spin.setValue(30)
            self.retry_spin.setValue(3)
            
            self.theme_color.setCurrentIndex(0)
            self.font_size.setValue(12)
            self.opacity_slider.setValue(95)
            
            self.default_path.setText(os.path.expanduser("~/Downloads"))
            self.default_threads.setValue(8)
            self.naming_rule.setCurrentIndex(0)
            
            self.debug_enabled.setChecked(False)
            self.log_level.setCurrentText("INFO")
            self.cache_size.setValue(100)
            
            CustomMessageBox.show_success(
                self,
                "ÊÅ¢Â§çÊàêÂäü üéä",
                "ÊâÄÊúâËÆæÁΩÆÂ∑≤ÊÅ¢Â§çÂà∞ÈªòËÆ§Áä∂ÊÄÅÔºÅ\n\nüåü ÈáçÊñ∞ÂºÄÂßã‰Ω†ÁöÑËêåËêå‰πãÊóÖÂêß~ (¬¥‚àÄ`)"
            )
    
    def preview_theme(self, theme_index):
        """ÂÆûÊó∂È¢ÑËßà‰∏ªÈ¢ò"""
        if self.main_window and hasattr(self.main_window, 'apply_theme'):
            self.main_window.apply_theme(theme_index)
    
    def center_on_screen(self):
        """Â∞ÜÂØπËØùÊ°ÜÂ±Ö‰∏≠ÊòæÁ§∫"""
        from PySide6.QtGui import QGuiApplication
        
        screen = QGuiApplication.primaryScreen()
        if screen:
            screen_geometry = screen.availableGeometry()
            dialog_geometry = self.geometry()
            
            x = (screen_geometry.width() - dialog_geometry.width()) // 2 + screen_geometry.x()
            y = (screen_geometry.height() - dialog_geometry.height()) // 2 + screen_geometry.y()
            
            self.move(x, y)


class HeadersDialog(QDialog):
    """ËØ∑Ê±ÇÂ§¥ÈÖçÁΩÆÂØπËØùÊ°Ü"""
    
    def __init__(self, parent=None, current_headers=None):
        super().__init__(parent)
        self.current_headers = current_headers or {}
        self.setup_ui()
    
    def setup_ui(self):
        self.setWindowTitle("üîß ËØ∑Ê±ÇÂ§¥ÈÖçÁΩÆ ‚ú®")
        self.setMinimumSize(600, 400)
        
        # ËÆæÁΩÆÂØπËØùÊ°ÜÊ†∑Âºè
        self.setStyleSheet("""
            QDialog {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 #fef7ff, stop:0.5 #f0f9ff, stop:1 #f3e8ff);
            }
        """)
        
        layout = QVBoxLayout(self)
        
        # ËØ¥ÊòéÊñáÊú¨
        info_label = QLabel("üí° ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâËØ∑Ê±ÇÂ§¥ÔºàJSONÊ†ºÂºèÊàñÊØèË°å‰∏Ä‰∏™ÈîÆÂÄºÂØπÔºâ:")
        info_label.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        info_label.setStyleSheet("color: #c44cfc; margin: 10px 0;")
        layout.addWidget(info_label)
        
        # Á§∫‰æãÊñáÊú¨
        example_text = '''üåü Á§∫‰æãÊ†ºÂºèÔºö
{
    "referer": "https://example.com/",
    "origin": "https://example.com",
    "sec-ch-ua": "\\"Not;A=Brand\\";v=\\"99\\", \\"Google Chrome\\";v=\\"139\\"",
    "sec-fetch-site": "cross-site"
}

üí´ ÊàñËÄÖÊØèË°å‰∏Ä‰∏™Ôºö
referer: https://example.com/
origin: https://example.com'''
        
        example_label = QLabel(example_text)
        example_label.setFont(QFont("Consolas", 9))
        example_label.setStyleSheet("""
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 rgba(196, 76, 252, 0.05), 
                stop:1 rgba(167, 139, 250, 0.05)); 
            padding: 12px; 
            border-radius: 8px; 
            color: #6b7280;
            border: 1px solid rgba(196, 76, 252, 0.2);
        """)
        layout.addWidget(example_label)
        
        # ÊñáÊú¨ÁºñËæëÂô®
        self.text_edit = QPlainTextEdit()
        self.text_edit.setFont(QFont("Consolas", 10))
        self.text_edit.setPlainText(self._headers_to_text())
        self.text_edit.setStyleSheet("""
            QPlainTextEdit {
                border: 2px solid #ddd6fe;
                border-radius: 12px;
                padding: 12px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
                color: #374151;
                selection-background-color: #c44cfc;
                font-family: "Consolas";
            }
            QPlainTextEdit:focus {
                border-color: #c44cfc;
                box-shadow: 0 0 0 3px rgba(196, 76, 252, 0.2);
            }
        """)
        layout.addWidget(self.text_edit)
        
        # ÊåâÈíÆ
        button_box = QDialogButtonBox(
            QDialogButtonBox.Ok | QDialogButtonBox.Cancel,
            parent=self
        )
        button_box.setStyleSheet("""
            QDialogButtonBox QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #667eea, stop:1 #5a6fd8);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 8px 16px;
                font-family: "Microsoft YaHei";
                font-weight: bold;
                font-size: 12px;
                min-width: 80px;
                min-height: 32px;
                margin: 3px;
            }
            QDialogButtonBox QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #7b8ef0, stop:1 #667eea);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            }
            QDialogButtonBox QPushButton:pressed {
                transform: translateY(0px);
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #5a6fd8, stop:1 #4c5fd6);
            }
        """)
        button_box.accepted.connect(self.accept)
        button_box.rejected.connect(self.reject)
        layout.addWidget(button_box)
    
    def _headers_to_text(self):
        """Â∞ÜËØ∑Ê±ÇÂ§¥Â≠óÂÖ∏ËΩ¨Êç¢‰∏∫ÊñáÊú¨"""
        if not self.current_headers:
            return ""
        
        import json
        return json.dumps(self.current_headers, indent=2, ensure_ascii=False)
    
    def get_headers(self):
        """Ëé∑ÂèñÁî®Êà∑ËæìÂÖ•ÁöÑËØ∑Ê±ÇÂ§¥"""
        text = self.text_edit.toPlainText().strip()
        if not text:
            return {}
        
        try:
            # Â∞ùËØïËß£Êûê‰∏∫JSON
            import json
            return json.loads(text)
        except json.JSONDecodeError:
            # Â∞ùËØïÊåâË°åËß£Êûê
            headers = {}
            for line in text.split('\n'):
                line = line.strip()
                if ':' in line:
                    key, value = line.split(':', 1)
                    headers[key.strip()] = value.strip()
            return headers


class MainWindow(QMainWindow):
    """‰∏ªÁ™óÂè£"""
    
    def __init__(self):
        super().__init__()
        self.download_tasks = []
        self.custom_headers = {}  # Â≠òÂÇ®Áî®Êà∑Ëá™ÂÆö‰πâËØ∑Ê±ÇÂ§¥
        self.setup_ui()
        self.load_user_settings()  # Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
        
    def setup_ui(self):
        """ËÆæÁΩÆUI"""
        self.setWindowTitle("üå∏ M3U8ËêåÂä®‰∏ãËΩΩÂô® v1.0 ‚ú®")
        self.setMinimumSize(1000, 800)
        self.resize(1200, 900)
        
        # ËÆæÁΩÆÁ™óÂè£ÂõæÊ†á
        try:
            icon_path = os.path.join(os.path.dirname(__file__), "assets", "favicon.ico")
            if os.path.exists(icon_path):
                self.setWindowIcon(QIcon(icon_path))
        except Exception as e:
            print(f"ËÆæÁΩÆÁ™óÂè£ÂõæÊ†áÂ§±Ë¥•: {e}")
        
        # ÂàõÂª∫ÊªöÂä®Âå∫Âüü‰Ωú‰∏∫‰∏≠Â§ÆÈÉ®‰ª∂
        main_scroll = QScrollArea()
        main_scroll.setWidgetResizable(True)
        main_scroll.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        main_scroll.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        main_scroll.setStyleSheet("""
            QScrollArea {
                border: none;
            }
        """)
        self.setCentralWidget(main_scroll)
        
        # ÊªöÂä®ÂÜÖÂÆπÂÆπÂô®
        central_widget = QWidget()
        main_scroll.setWidget(central_widget)
        
        # ‰∏ªÂ∏ÉÂ±Ä
        main_layout = QVBoxLayout(central_widget)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(16)
        
        # Ê†áÈ¢òÂå∫Âüü
        title_container = QWidget()
        title_layout = QVBoxLayout(title_container)
        title_layout.setContentsMargins(0, 0, 0, 0)
        
        # ‰∏ªÊ†áÈ¢ò
        title_label = QLabel("üå∏ M3U8ËêåÂä®‰∏ãËΩΩÂô® ‚ú®")
        title_label.setFont(QFont("Microsoft YaHei", 24, QFont.Bold))
        title_label.setAlignment(Qt.AlignCenter)
        title_label.setStyleSheet("""
            color: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                stop:0 #ff6b9d, stop:0.3 #c44cfc, stop:0.7 #667eea, stop:1 #06b6d4);
            margin: 15px 0px;
            padding: 20px;
            border-radius: 20px;
            background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                stop:0 rgba(255, 107, 157, 0.08), 
                stop:0.5 rgba(196, 76, 252, 0.05), 
                stop:1 rgba(6, 182, 212, 0.08));
            border: 2px solid transparent;
            border-image: linear-gradient(45deg, #ff6b9d, #c44cfc, #667eea, #06b6d4) 1;
            text-shadow: 0 0 10px rgba(255, 107, 157, 0.5);
        """)
        title_layout.addWidget(title_label)
        
        # ÂâØÊ†áÈ¢ò
        subtitle_label = QLabel("üí´ ÂèØÁà±ÂèàÂº∫Â§ßÁöÑ‰∫åÊ¨°ÂÖÉËßÜÈ¢ë‰∏ãËΩΩÂä©Êâã ~ (¬¥‚àÄ`)")
        subtitle_label.setFont(QFont("Microsoft YaHei", 12))
        subtitle_label.setAlignment(Qt.AlignCenter)
        subtitle_label.setStyleSheet("""
            color: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                stop:0 #a78bfa, stop:1 #06b6d4); 
            margin-bottom: 15px;
            font-weight: 500;
        """)
        title_layout.addWidget(subtitle_label)
        
        # GitHubÈìæÊé•
        github_label = QLabel('üîó <a href="https://github.com/shayuaidoudou/m3u8-anime-downloader" style="color: #c44cfc; text-decoration: none;">@shayuaidoudou/m3u8-anime-downloader</a> | üíï Made with love for anime fans')
        github_label.setFont(QFont("Microsoft YaHei", 9))
        github_label.setAlignment(Qt.AlignCenter)
        github_label.setOpenExternalLinks(True)
        github_label.setStyleSheet("""
            color: #a78bfa;
            margin-bottom: 20px;
        """)
        title_layout.addWidget(github_label)
        
        main_layout.addWidget(title_container)
        
        # ËæìÂÖ•ËÆæÁΩÆÂå∫Âüü
        input_widget = QWidget()
        input_layout = QVBoxLayout(input_widget)
        
        # ËæìÂÖ•ÁªÑ
        input_group = QGroupBox("‰∏ãËΩΩËÆæÁΩÆ")
        input_group.setFont(QFont("Microsoft YaHei", 11, QFont.Bold))
        input_group_layout = QGridLayout(input_group)
        input_group_layout.setSpacing(15)
        
        # M3U8 URLËæìÂÖ•
        url_label = QLabel("üéµ ËßÜÈ¢ëÈìæÊé•:")
        url_label.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        url_label.setStyleSheet("color: #c44cfc; margin-bottom: 8px;")
        input_group_layout.addWidget(url_label, 0, 0)
        
        self.url_input = ModernLineEdit("üéµ ËØ∑ËæìÂÖ•M3U8ËßÜÈ¢ëÈìæÊé•... (¬¥‚àÄ`)")
        input_group_layout.addWidget(self.url_input, 0, 1, 1, 2)
        
        # ËæìÂá∫Ë∑ØÂæÑ
        output_label = QLabel("üíù ‰øùÂ≠ò‰ΩçÁΩÆ:")
        output_label.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        output_label.setStyleSheet("color: #c44cfc; margin-bottom: 8px;")
        input_group_layout.addWidget(output_label, 1, 0)
        
        self.output_input = ModernLineEdit("üíù ÈÄâÊã©‰øùÂ≠òË∑ØÂæÑ... ‚ú®")
        input_group_layout.addWidget(self.output_input, 1, 1)
        
        self.browse_btn = ModernButton("ÊµèËßà", icon_text="üìÇ")
        self.browse_btn.clicked.connect(self.browse_output_path)
        input_group_layout.addWidget(self.browse_btn, 1, 2)
        
        # È´òÁ∫ßËÆæÁΩÆ
        threads_label = QLabel("üåü Á∫øÁ®ãÊï∞:")
        threads_label.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        threads_label.setStyleSheet("color: #c44cfc; margin-bottom: 8px;")
        input_group_layout.addWidget(threads_label, 2, 0)
        
        self.threads_spin = QSpinBox()
        self.threads_spin.setRange(1, 32)
        self.threads_spin.setValue(DEFAULT_CONFIG['max_workers'])
        self.threads_spin.setMinimumHeight(48)
        self.threads_spin.setStyleSheet("""
            QSpinBox {
                border: 2px solid #ddd6fe;
                border-radius: 16px;
                padding: 14px 20px;
                font-size: 14px;
                font-weight: bold;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #fef7ff, stop:1 #f9fafb);
                color: #374151;
                selection-background-color: #c44cfc;
                box-shadow: inset 0 2px 8px rgba(196, 76, 252, 0.08);
            }
            QSpinBox:focus {
                border-color: #c44cfc;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
                box-shadow: 0 0 0 4px rgba(196, 76, 252, 0.25), 
                           inset 0 2px 8px rgba(196, 76, 252, 0.1);
            }
            QSpinBox:hover {
                border-color: #a78bfa;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
            }
            QSpinBox::up-button, QSpinBox::down-button {
                border: none;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(196, 76, 252, 0.1), 
                    stop:1 rgba(167, 139, 250, 0.1));
                width: 24px;
                border-radius: 8px;
                margin: 2px;
            }
            QSpinBox::up-button:hover, QSpinBox::down-button:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(196, 76, 252, 0.2), 
                    stop:1 rgba(167, 139, 250, 0.2));
                box-shadow: 0 2px 8px rgba(196, 76, 252, 0.3);
            }
            QSpinBox::up-arrow {
                image: none;
                border: 3px solid transparent;
                border-bottom: 6px solid #c44cfc;
                width: 0px;
                height: 0px;
            }
            QSpinBox::down-arrow {
                image: none;
                border: 3px solid transparent;
                border-top: 6px solid #c44cfc;
                width: 0px;
                height: 0px;
            }
        """)
        input_group_layout.addWidget(self.threads_spin, 2, 1)
        
        # ‰ªªÂä°ÂêçÁß∞
        task_name_label = QLabel("üéÄ ‰ªªÂä°ÂêçÁß∞:")
        task_name_label.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        task_name_label.setStyleSheet("color: #c44cfc; margin-bottom: 8px;")
        input_group_layout.addWidget(task_name_label, 3, 0)
        
        self.task_name_input = ModernLineEdit("üéÄ ËêåËêåÁöÑ‰ªªÂä° ‚ô°")
        input_group_layout.addWidget(self.task_name_input, 3, 1)
        
        # ËØ∑Ê±ÇÂ§¥ËÆæÁΩÆÊåâÈíÆ
        self.headers_btn = ModernButton("ËØ∑Ê±ÇÂ§¥ËÆæÁΩÆ", icon_text="üîß")
        self.headers_btn.clicked.connect(self.show_headers_dialog)
        input_group_layout.addWidget(self.headers_btn, 3, 2)
        
        # È¢ÑËÆæÊ®°Êùø‰∏ãÊãâÊ°Ü
        template_label = QLabel("üõ°Ô∏è ÂèçÁà¨Ëô´Ê®°Êùø:")
        template_label.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
        template_label.setStyleSheet("color: #c44cfc; margin-bottom: 8px;")
        input_group_layout.addWidget(template_label, 4, 0)
        
        self.template_combo = self._create_template_combo()
        input_group_layout.addWidget(self.template_combo, 4, 1)
        
        # Ê∑ªÂä†‰ªªÂä°ÊåâÈíÆ
        self.add_task_btn = ModernButton("Ê∑ªÂä†ËêåËêå‰ªªÂä°", primary=True, icon_text="üí´")
        self.add_task_btn.clicked.connect(self.add_download_task)
        self.add_task_btn.setMinimumHeight(60)
        self.add_task_btn.setFont(QFont("Microsoft YaHei", 12, QFont.Bold))
        input_group_layout.addWidget(self.add_task_btn, 4, 2)
        
        input_layout.addWidget(input_group)
        main_layout.addWidget(input_widget)
        
        # ‰∏ãËΩΩ‰ªªÂä°Âå∫Âüü - Áªô‰∫àÂÖÖË∂≥ÁöÑÁ©∫Èó¥
        task_widget = QWidget()
        task_layout = QVBoxLayout(task_widget)
        
        task_group = QGroupBox("‰∏ãËΩΩ‰ªªÂä°")
        task_group.setFont(QFont("Microsoft YaHei", 11, QFont.Bold))
        self.task_layout = QVBoxLayout(task_group)
        
        # ‰ªªÂä°ÂàóË°®ÊªöÂä®Âå∫Âüü
        self.scroll_area = QScrollArea()
        self.scroll_area.setWidgetResizable(True)
        self.scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.scroll_area.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        self.scroll_area.setStyleSheet("""
            QScrollArea {
                border: none;
                background: transparent;
            }
        """)
        
        self.task_container = QWidget()
        self.task_container_layout = QVBoxLayout(self.task_container)
        self.task_container_layout.addStretch()
        
        self.scroll_area.setWidget(self.task_container)
        self.task_layout.addWidget(self.scroll_area)
        
        task_layout.addWidget(task_group)
        
        # ËÆæÁΩÆ‰ªªÂä°Âå∫ÂüüÁöÑÊúÄÂ∞èÈ´òÂ∫¶ÔºåËÆ©ÂÆÉÊõ¥Â§ßÊõ¥Â•ΩÁî®
        task_widget.setMinimumHeight(800)  # Êõ¥Â§ßÁöÑ‰ªªÂä°ÊòæÁ§∫Âå∫Âüü
        main_layout.addWidget(task_widget)
        
        # ËÆæÁΩÆÂÜÖÂÆπÂå∫ÂüüÁöÑÊúÄÂ∞èÈ´òÂ∫¶ÔºåÁ°Æ‰øùË∂ÖÂá∫Á™óÂè£Êó∂ÊòæÁ§∫ÊªöÂä®Êù°
        central_widget.setMinimumHeight(1400)  # ÊÄªÈ´òÂ∫¶ÊØîÁ™óÂè£È´òÔºå‰ºöÂá∫Áé∞ÊªöÂä®Êù°
        
        # Áä∂ÊÄÅÊ†è
        self.statusBar().showMessage("ÂáÜÂ§áÂ∞±Áª™")
        
        # ËèúÂçïÊ†è
        self.setup_menu()
    
    def _create_template_combo(self):
        """ÂàõÂª∫È¢ÑËÆæÊ®°Êùø‰∏ãÊãâÊ°Ü"""
        combo = QComboBox()
        combo.setMinimumHeight(48)
        combo.setStyleSheet("""
            QComboBox {
                border: 2px solid #ddd6fe;
                border-radius: 16px;
                padding: 14px 20px;
                font-size: 14px;
                font-weight: bold;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #fef7ff, stop:1 #f9fafb);
                color: #374151;
                box-shadow: inset 0 2px 8px rgba(196, 76, 252, 0.08);
            }
            QComboBox:focus {
                border-color: #c44cfc;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
                box-shadow: 0 0 0 4px rgba(196, 76, 252, 0.25), 
                           inset 0 2px 8px rgba(196, 76, 252, 0.1);
            }
            QComboBox:hover {
                border-color: #a78bfa;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
            }
            QComboBox::drop-down {
                border: none;
                width: 35px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(196, 76, 252, 0.1), 
                    stop:1 rgba(167, 139, 250, 0.1));
                border-radius: 12px;
                margin: 2px;
            }
            QComboBox::drop-down:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(196, 76, 252, 0.2), 
                    stop:1 rgba(167, 139, 250, 0.2));
            }
            QComboBox::down-arrow {
                image: none;
                border: 4px solid transparent;
                border-top: 8px solid #c44cfc;
                width: 0px;
                height: 0px;
                margin-right: 10px;
            }
            QComboBox QAbstractItemView {
                border: 2px solid #ddd6fe;
                border-radius: 16px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 #fef7ff);
                selection-background-color: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 rgba(255, 107, 157, 0.15), 
                    stop:1 rgba(196, 76, 252, 0.15));
                selection-color: #c44cfc;
                padding: 8px;
                font-weight: bold;
                box-shadow: 0 12px 35px rgba(196, 76, 252, 0.2);
            }
            QComboBox QAbstractItemView::item {
                padding: 12px 16px;
                border-radius: 12px;
                margin: 3px;
                color: #374151;
            }
            QComboBox QAbstractItemView::item:hover {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 rgba(255, 107, 157, 0.15), 
                    stop:1 rgba(196, 76, 252, 0.15));
                color: #c44cfc;
            }
        """)
        
        # È¢ÑËÆæÊ®°Êùø
        templates = {
            "ÈªòËÆ§ÔºàÊó†ÁâπÊÆäËØ∑Ê±ÇÂ§¥Ôºâ": {},
            "ÈÄöÁî®ÂèçÁà¨Ëô´": {
                "referer": "https://www.google.com/",
                "sec-ch-ua": '"Not;A=Brand";v="99", "Google Chrome";v="139", "Chromium";v="139"',
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": '"Windows"',
                "sec-fetch-dest": "empty",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "cross-site",
            },
            "Aigua TV": {
                "accept": "*/*",
                "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
                "cache-control": "no-cache",
                "origin": "https://aigua.tv",
                "pragma": "no-cache",
                "priority": "u=1, i",
                "referer": "https://aigua.tv/",
                "sec-ch-ua": '"Not;A=Brand";v="99", "Google Chrome";v="139", "Chromium";v="139"',
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": '"Windows"',
                "sec-fetch-dest": "empty",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "cross-site",
            },
            "ÁßªÂä®Á´ØÊ®°Êãü": {
                "user-agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1",
                "sec-ch-ua-mobile": "?1",
                "sec-fetch-dest": "empty",
                "sec-fetch-mode": "cors",
                "sec-fetch-site": "cross-site",
            }
        }
        
        for name, headers in templates.items():
            combo.addItem(name, headers)
        
        combo.currentTextChanged.connect(self._on_template_changed)
        return combo
    
    def _on_template_changed(self):
        """Ê®°ÊùøÈÄâÊã©ÊîπÂèòÊó∂ÁöÑÂ§ÑÁêÜ"""
        current_data = self.template_combo.currentData()
        if current_data:
            self.custom_headers = current_data.copy()
            # ÊòæÁ§∫Â∑≤ÈÄâÊã©Ê®°ÊùøÁöÑÊèêÁ§∫
            if current_data:
                self.statusBar().showMessage(f"Â∑≤ÈÄâÊã©Ê®°Êùø: {self.template_combo.currentText()}")
    
    def show_headers_dialog(self):
        """ÊòæÁ§∫ËØ∑Ê±ÇÂ§¥ÈÖçÁΩÆÂØπËØùÊ°Ü"""
        dialog = HeadersDialog(self, self.custom_headers)
        if dialog.exec() == QDialog.Accepted:
            self.custom_headers = dialog.get_headers()
            # ÈáçÁΩÆÊ®°ÊùøÈÄâÊã©
            self.template_combo.setCurrentIndex(0)
            if self.custom_headers:
                self.statusBar().showMessage(f"Â∑≤ÈÖçÁΩÆ {len(self.custom_headers)} ‰∏™Ëá™ÂÆö‰πâËØ∑Ê±ÇÂ§¥")
            else:
                self.statusBar().showMessage("Â∑≤Ê∏ÖÈô§Ëá™ÂÆö‰πâËØ∑Ê±ÇÂ§¥")
    
    def setup_menu(self):
        """ËÆæÁΩÆËèúÂçïÊ†è"""
        menubar = self.menuBar()
        
        # Êñá‰ª∂ËèúÂçï
        file_menu = menubar.addMenu("üìÇ Êñá‰ª∂")
        
        open_action = QAction("üìÅ ÊâìÂºÄ‰∏ãËΩΩÁõÆÂΩï", self)
        open_action.triggered.connect(self.open_download_folder)
        file_menu.addAction(open_action)
        
        file_menu.addSeparator()
        
        exit_action = QAction("üö™ ÈÄÄÂá∫", self)
        exit_action.triggered.connect(self.close)
        file_menu.addAction(exit_action)
        
        # Â∑•ÂÖ∑ËèúÂçï
        tools_menu = menubar.addMenu("üõ†Ô∏è Â∑•ÂÖ∑")
        
        # ËÆæÁΩÆÈÄâÈ°π
        settings_action = QAction("‚öôÔ∏è ËêåËêåËÆæÁΩÆ", self)
        settings_action.triggered.connect(self.show_settings)
        tools_menu.addAction(settings_action)
        
        tools_menu.addSeparator()
        
        # ËØ∑Ê±ÇÂ§¥ÈÖçÁΩÆ
        headers_action = QAction("üîß ËØ∑Ê±ÇÂ§¥ÈÖçÁΩÆ", self)
        headers_action.triggered.connect(self.show_headers_dialog)
        tools_menu.addAction(headers_action)
        
        # Â∏ÆÂä©ËèúÂçï
        help_menu = menubar.addMenu("‚ùì Â∏ÆÂä©")
        
        about_action = QAction("‚ÑπÔ∏è ÂÖ≥‰∫é", self)
        about_action.triggered.connect(self.show_about)
        help_menu.addAction(about_action)
        
        # GitHubËèúÂçï - Êõ¥ÂèØÈù†ÁöÑÊòæÁ§∫ÊñπÂºè
        github_menu = menubar.addMenu("‚≠ê GitHub")
        
        github_action = QAction("üîó ËÆøÈóÆGitHub‰ªìÂ∫ì", self)
        github_action.triggered.connect(self.open_github_repo)
        github_menu.addAction(github_action)
        
        # ÂèØÈÄâÔºöÂ¶ÇÊûúÁ≥ªÁªüÊîØÊåÅÔºå‰ªçÁÑ∂Â∞ùËØïÂú®Âè≥‰∏äËßíÊ∑ªÂä†ÊåâÈíÆ
        try:
            github_btn = QPushButton("‚≠ê")
            github_btn.setFixedSize(30, 25)
            github_btn.setCursor(Qt.PointingHandCursor)
            github_btn.setToolTip("ËÆøÈóÆGitHub‰ªìÂ∫ì ‚ú®")
            github_btn.setStyleSheet("""
                QPushButton {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                        stop:0 rgba(255, 107, 157, 0.8), 
                        stop:0.5 rgba(196, 76, 252, 0.8), 
                        stop:1 rgba(102, 126, 234, 0.8));
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    border-radius: 12px;
                    color: white;
                    font-weight: bold;
                    font-size: 14px;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                }
                QPushButton:hover {
                    background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                        stop:0 rgba(255, 107, 157, 1.0), 
                        stop:0.5 rgba(196, 76, 252, 1.0), 
                        stop:1 rgba(102, 126, 234, 1.0));
                    border-color: rgba(255, 255, 255, 0.5);
                }
            """)
            github_btn.clicked.connect(self.open_github_repo)
            menubar.setCornerWidget(github_btn, Qt.TopRightCorner)
        except Exception:
            # Â¶ÇÊûúËßíËêΩÁªÑ‰ª∂‰∏çÊîØÊåÅÔºåÂøΩÁï•ÈîôËØØ
            pass
    
    def open_github_repo(self):
        """ÊâìÂºÄGitHub‰ªìÂ∫ì"""
        try:
            github_url = "https://github.com/shayuaidoudou/m3u8-anime-downloader"
            QDesktopServices.openUrl(QUrl(github_url))
            self.statusBar().showMessage("Ê≠£Âú®ÊâìÂºÄGitHub‰ªìÂ∫ì... ‚ú®")
        except Exception as e:
            self.statusBar().showMessage(f"ÊâìÂºÄGitHubÂ§±Ë¥•: {str(e)}")
    
    def browse_output_path(self):
        """ÊµèËßàËæìÂá∫Ë∑ØÂæÑ"""
        file_path, _ = QFileDialog.getSaveFileName(
            self,
            "ÈÄâÊã©‰øùÂ≠òË∑ØÂæÑ",
            "",
            "MP4Êñá‰ª∂ (*.mp4);;TSÊñá‰ª∂ (*.ts);;ÊâÄÊúâÊñá‰ª∂ (*.*)"
        )
        
        if file_path:
            self.output_input.setText(file_path)
    
    def add_download_task(self):
        """Ê∑ªÂä†‰∏ãËΩΩ‰ªªÂä°"""
        url = self.url_input.text().strip()
        output_path = self.output_input.text().strip()
        task_name = self.task_name_input.text().strip()
        
        # È™åËØÅURL
        if not url:
            CustomMessageBox.show_warning(self, "ÊèêÁ§∫ ‚ô°", "ËØ∑ËæìÂÖ•M3U8ÈìæÊé•Âì¶~ (¬¥‚àÄ`)")
            return
        
        if not is_valid_m3u8_url(url):
            CustomMessageBox.show_warning(self, "ÊèêÁ§∫ ‚ô°", "ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑM3U8ÈìæÊé•Âë¢~ (‡πë‚Ä¢ÃÄ„ÖÇ‚Ä¢ÃÅ)Ÿà‚úß")
            return
        
        # È™åËØÅËæìÂá∫Ë∑ØÂæÑ
        if not output_path:
            CustomMessageBox.show_warning(self, "ÊèêÁ§∫ ‚ô°", "ËØ∑ÈÄâÊã©‰øùÂ≠òË∑ØÂæÑÂì¶~ (Ôø£‚ñΩÔø£)")
            return
        
        # Á°Æ‰øùÊñá‰ª∂Êâ©Â±ïÂêç
        output_path = ensure_extension(output_path)
        
        # È™åËØÅËæìÂá∫Ë∑ØÂæÑ
        is_valid, error_msg = validate_output_path(output_path)
        if not is_valid:
            CustomMessageBox.show_warning(self, "ÊèêÁ§∫ ‚ô°", f"ËæìÂá∫Ë∑ØÂæÑÊúâÈóÆÈ¢òÂë¢~ {error_msg} (‡πëÔºû‚ó°Ôºú‡πë)")
            return
        
        # ÈÅøÂÖçÊñá‰ª∂ÂêçÂÜ≤Á™Å
        output_path = get_available_filename(output_path)
        
        # ÁîüÊàê‰ªªÂä°ÂêçÁß∞
        if not task_name:
            task_name = extract_title_from_url(url)
            if not task_name or task_name == "Êú™Áü•ËßÜÈ¢ë":
                task_name = f"ËêåËêå‰ªªÂä°_{len(self.download_tasks) + 1} ‚ú®"
        
        # ÂàõÂª∫‰ªªÂä°ÁªÑ‰ª∂ÔºàÂåÖÂê´Ëá™ÂÆö‰πâËØ∑Ê±ÇÂ§¥Ôºâ
        task_widget = DownloadTaskWidget(task_name, url, output_path, self.custom_headers.copy())
        
        # ÊèíÂÖ•Âà∞‰ªªÂä°ÂÆπÂô®ÁöÑÊúÄÂêé‰∏Ä‰∏™‰ΩçÁΩÆÔºàstretch‰πãÂâçÔºâ
        self.task_container_layout.insertWidget(
            self.task_container_layout.count() - 1, 
            task_widget
        )
        
        self.download_tasks.append(task_widget)
        
        # Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        self.url_input.clear()
        self.task_name_input.setText("ËêåËêåÁöÑ‰ªªÂä° ‚ô°")
        
        # ÊòæÁ§∫‰ªªÂä°‰ø°ÊÅØ
        headers_info = f" (ÂåÖÂê´ {len(self.custom_headers)} ‰∏™Ëá™ÂÆö‰πâËØ∑Ê±ÇÂ§¥)" if self.custom_headers else ""
        self.statusBar().showMessage(f"Â∑≤Ê∑ªÂä†‰ªªÂä°: {task_name}{headers_info}")
    
    def open_download_folder(self):
        """ÊâìÂºÄ‰∏ãËΩΩÊñá‰ª∂Â§π"""
        if self.download_tasks:
            last_output = self.download_tasks[-1].output_path
            folder_path = os.path.dirname(last_output)
            if os.path.exists(folder_path):
                QDesktopServices.openUrl(QUrl.fromLocalFile(folder_path))
            else:
                CustomMessageBox.show_info(self, "ÊèêÁ§∫ ‚ô°", "‰∏ãËΩΩÊñá‰ª∂Â§π‰∏çÂ≠òÂú®Âë¢~ (¬¥ÔΩ•œâÔΩ•`)")
        else:
            CustomMessageBox.show_info(self, "ÊèêÁ§∫ ‚ô°", "ËøòÊ≤°Êúâ‰∏ãËΩΩ‰ªªÂä°Âì¶~ Âø´Êù•Ê∑ªÂä†‰∏Ä‰∏™ÂêßÔºÅ „ÉΩ(¬∞„Äá¬∞)Ôæâ")
    
    def show_settings(self):
        """ÊòæÁ§∫ËÆæÁΩÆÂØπËØùÊ°Ü"""
        settings_dialog = SettingsDialog(self)
        settings_dialog.exec()
    
    def show_about(self):
        """ÊòæÁ§∫ÂÖ≥‰∫éÂØπËØùÊ°Ü"""
        about_message = """üå∏ M3U8ËêåÂä®‰∏ãËΩΩÂô® v1.0 ‚ú®

üíñ ‰∏Ä‰∏™Ë∂ÖÂèØÁà±ÁöÑ‰∫åÊ¨°ÂÖÉÈ£éÊ†ºËßÜÈ¢ë‰∏ãËΩΩÂ∑•ÂÖ∑ (¬¥‚àÄ`)

üåü ËêåËêåÂäüËÉΩÔºö
‚Ä¢ üöÄ ÊîØÊåÅÂ§öÁ∫øÁ®ãÈ´òÈÄü‰∏ãËΩΩ
‚Ä¢ üîê ÊîØÊåÅAESÂä†ÂØÜËßÜÈ¢ëËß£ÂØÜ  
‚Ä¢ üé® ‰∫åÊ¨°ÂÖÉÈ£éÊ†ºÁé∞‰ª£ÂåñÁïåÈù¢
‚Ä¢ üìã ‰ªªÂä°ÁÆ°ÁêÜÂíåËøõÂ∫¶ÊòæÁ§∫
‚Ä¢ üí´ ÂèØÁà±ÁöÑËßÜËßâÊïàÊûú
‚Ä¢ üõ°Ô∏è Êô∫ËÉΩÂèçÁà¨Ëô´ÂäüËÉΩ

üõ†Ô∏è Âü∫‰∫é PySide6 ÊûÑÂª∫
üîó ÂºÄÊ∫êÂú∞ÂùÄ: github.com/shayuaidoudou/m3u8-anime-downloader
üíï Made with love for anime fans ~"""
        
        CustomMessageBox.show_info(
            self,
            "ÂÖ≥‰∫é M3U8ËêåÂä®‰∏ãËΩΩÂô®",
            about_message
        )
    
    def apply_theme(self, theme_index):
        """Â∫îÁî®‰∏ªÈ¢òÈ¢úËâ≤"""
        # ÂÆö‰πâ‰∏ªÈ¢òËâ≤ÊñπÊ°à
        themes = {
            0: {  # üíô ÁªèÂÖ∏ËìùÁ¥´
                'primary': '#667eea',
                'secondary': '#764ba2', 
                'accent': '#c44cfc',
                'bg_start': '#fef7ff',
                'bg_mid': '#f0f9ff',
                'bg_end': '#f3e8ff'
            },
            1: {  # üíñ ÂèØÁà±Á≤âËâ≤
                'primary': '#ff6b9d',
                'secondary': '#f093fb',
                'accent': '#ff8cc8',
                'bg_start': '#fef7f7',
                'bg_mid': '#fff0f5',
                'bg_end': '#fdf2f8'
            },
            2: {  # üíö Ê∏ÖÊñ∞ÁªøËâ≤
                'primary': '#10b981',
                'secondary': '#34d399',
                'accent': '#059669',
                'bg_start': '#f0fdf4',
                'bg_mid': '#ecfdf5',
                'bg_end': '#d1fae5'
            },
            3: {  # üíõ Ê¥ªÂäõÊ©ôËâ≤
                'primary': '#f59e0b',
                'secondary': '#fbbf24',
                'accent': '#d97706',
                'bg_start': '#fffbeb',
                'bg_mid': '#fef3c7',
                'bg_end': '#fed7aa'
            },
            4: {  # üíú Á•ûÁßòÁ¥´Ëâ≤
                'primary': '#8b5cf6',
                'secondary': '#a78bfa',
                'accent': '#7c3aed',
                'bg_start': '#faf5ff',
                'bg_mid': '#f3e8ff',
                'bg_end': '#e9d5ff'
            },
            5: {  # ‚ù§Ô∏è ÊøÄÊÉÖÁ∫¢Ëâ≤
                'primary': '#ef4444',
                'secondary': '#f87171',
                'accent': '#dc2626',
                'bg_start': '#fef2f2',
                'bg_mid': '#fee2e2',
                'bg_end': '#fecaca'
            }
        }
        
        # Ëé∑ÂèñÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò
        theme = themes.get(theme_index, themes[0])
        
        # Â∫îÁî®‰∏ªÈ¢òÊ†∑Âºè
        self.setStyleSheet(f"""
            QMainWindow {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 {theme['bg_start']}, stop:0.25 {theme['bg_mid']}, 
                    stop:0.5 {theme['bg_end']}, stop:0.75 {theme['bg_mid']}, stop:1 {theme['bg_start']});
            }}
            QGroupBox {{
                font-weight: bold;
                border: 2px solid {theme['primary']};
                border-radius: 20px;
                margin: 15px 6px;
                padding-top: 20px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(255, 255, 255, 0.9), 
                    stop:0.5 rgba(254, 247, 255, 0.8), 
                    stop:1 rgba(243, 232, 255, 0.9));
                box-shadow: 0 8px 30px rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.15);
            }}
            QGroupBox::title {{
                subcontrol-origin: margin;
                left: 25px;
                padding: 6px 16px;
                color: {theme['accent']};
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.15), 
                    stop:1 rgba({self._theme_hex_to_rgb(theme['accent'])}, 0.15));
                border-radius: 12px;
                font-size: 13px;
                font-weight: bold;
                border: 1px solid rgba({self._theme_hex_to_rgb(theme['accent'])}, 0.2);
            }}
            QLabel {{
                color: #2c3e50;
                font-family: "Microsoft YaHei";
            }}
            QStatusBar {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 {theme['bg_start']}, stop:0.5 {theme['bg_mid']}, stop:1 {theme['bg_end']});
                border-top: 2px solid {theme['primary']};
                color: {theme['accent']};
                font-weight: bold;
                padding: 10px;
                border-radius: 0px 0px 8px 8px;
            }}
            QMenuBar {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 {theme['bg_start']}, stop:0.5 {theme['bg_mid']}, stop:1 {theme['bg_end']});
                border-bottom: 2px solid {theme['primary']};
                padding: 8px;
                border-radius: 8px 8px 0px 0px;
            }}
            QMenuBar::item {{
                padding: 12px 18px;
                border-radius: 12px;
                font-weight: bold;
                color: #374151;
            }}
            QMenuBar::item:selected {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.15), 
                    stop:1 rgba({self._theme_hex_to_rgb(theme['accent'])}, 0.15));
                color: {theme['accent']};
            }}
            QMenu {{
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #ffffff, stop:1 {theme['bg_start']});
                border: 2px solid {theme['primary']};
                border-radius: 16px;
                padding: 10px;
                box-shadow: 0 12px 35px rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.2);
            }}
            QMenu::item {{
                padding: 12px 20px;
                border-radius: 12px;
                font-weight: bold;
                color: #374151;
                margin: 3px;
            }}
            QMenu::item:selected {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.15), 
                    stop:1 rgba({self._theme_hex_to_rgb(theme['accent'])}, 0.15));
                color: {theme['accent']};
            }}
            QScrollBar:vertical {{
                background: rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.1);
                width: 14px;
                border-radius: 7px;
            }}
            QScrollBar::handle:vertical {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 {theme['primary']}, stop:0.5 {theme['accent']}, stop:1 {theme['secondary']});
                border-radius: 7px;
                min-height: 25px;
                box-shadow: 0 2px 8px rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.3);
            }}
            QScrollBar::handle:vertical:hover {{
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 {theme['secondary']}, stop:0.5 {theme['accent']}, stop:1 {theme['primary']});
                box-shadow: 0 4px 12px rgba({self._theme_hex_to_rgb(theme['primary'])}, 0.5);
            }}
            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {{
                border: none;
                background: none;
            }}
        """)
        
        print(f"üé® Â∑≤Â∫îÁî®‰∏ªÈ¢ò: {theme_index} - {['üíô ÁªèÂÖ∏ËìùÁ¥´', 'üíñ ÂèØÁà±Á≤âËâ≤', 'üíö Ê∏ÖÊñ∞ÁªøËâ≤', 'üíõ Ê¥ªÂäõÊ©ôËâ≤', 'üíú Á•ûÁßòÁ¥´Ëâ≤', '‚ù§Ô∏è ÊøÄÊÉÖÁ∫¢Ëâ≤'][theme_index]}")
    
    def _theme_hex_to_rgb(self, hex_color):
        """Â∞ÜÂçÅÂÖ≠ËøõÂà∂È¢úËâ≤ËΩ¨Êç¢‰∏∫RGBÔºàÁî®‰∫é‰∏ªÈ¢òÔºâ"""
        hex_color = hex_color.lstrip('#')
        return ', '.join(str(int(hex_color[i:i+2], 16)) for i in (0, 2, 4))
    
    def load_user_settings(self):
        """ÂêØÂä®Êó∂Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ"""
        settings_file = os.path.join(os.path.dirname(__file__), "settings.json")
        
        try:
            if os.path.exists(settings_file):
                with open(settings_file, 'r', encoding='utf-8') as f:
                    settings = json.load(f)
                
                # Â∫îÁî®UIËÆæÁΩÆ
                ui = settings.get('ui', {})
                opacity = ui.get('opacity', 95) / 100.0
                self.setWindowOpacity(opacity)
                
                # Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
                theme_index = ui.get('theme_color', 0)
                self.apply_theme(theme_index)
                
                # Â∫îÁî®‰∏ãËΩΩËÆæÁΩÆ
                download = settings.get('download', {})
                
                # ËÆæÁΩÆÈªòËÆ§Á∫øÁ®ãÊï∞
                default_threads = download.get('default_threads', DEFAULT_CONFIG['max_workers'])
                if hasattr(self, 'threads_spin'):
                    self.threads_spin.setValue(default_threads)
                
                # ËÆæÁΩÆÈªòËÆ§‰øùÂ≠òË∑ØÂæÑ
                default_path = download.get('default_path', '')
                if default_path and os.path.exists(default_path) and hasattr(self, 'output_input'):
                    self.output_input.setText(default_path)
                
                print(f"‚úÖ Â∑≤Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ: Á∫øÁ®ãÊï∞={default_threads}, Ë∑ØÂæÑ={default_path}, ‰∏ªÈ¢ò={theme_index}")
                
        except Exception as e:
            print(f"‚ö†Ô∏è Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•: {e}")
            # ÁªßÁª≠‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ


def main():
    """‰∏ªÂáΩÊï∞"""
    app = QApplication(sys.argv)
    app.setApplicationName("M3U8ËêåÂä®‰∏ãËΩΩÂô®")
    app.setOrganizationName("M3U8AnimeDownloader")
    
    # ËÆæÁΩÆÂ∫îÁî®ÂõæÊ†á
    try:
        icon_path = os.path.join(os.path.dirname(__file__), "assets", "favicon.ico")
        if os.path.exists(icon_path):
            app.setWindowIcon(QIcon(icon_path))
    except Exception as e:
        print(f"ËÆæÁΩÆÂ∫îÁî®ÂõæÊ†áÂ§±Ë¥•: {e}")
    
    window = MainWindow()
    window.show()
    
    sys.exit(app.exec())


if __name__ == "__main__":
    main()
