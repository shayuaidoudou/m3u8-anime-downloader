# 🔐 M3U8下载器反爬虫功能完整指南

## 💡 功能概述

许多视频网站现在都使用请求头检查来防止盗链和爬虫访问。我们的下载器现在完全支持自定义请求头，可以绕过这些反爬虫限制！

## 🚀 快速开始

### 1. 启动程序
```bash
# Windows
run.bat

# Linux/macOS  
./run.sh
```

### 2. 选择模式
- 选择 **"1. 启动GUI界面"** 进入图形界面
- 选择 **"3. 测试自定义请求头功能"** 先测试功能

## 🎯 GUI界面使用

### 方法1：使用预设模板（推荐）

在主界面找到**"反爬虫模板"**下拉框，选择适合的模板：

- **默认（无特殊请求头）** - 普通网站
- **通用反爬虫** - 大多数需要简单反爬的网站
- **Aigua TV** - 专为Aigua TV优化（您的示例网站）
- **移动端模拟** - 模拟手机访问

选择后状态栏会显示："已选择模板: xxx"

### 方法2：自定义请求头

1. 点击**"请求头设置"**按钮
2. 在弹出对话框中输入请求头

**支持两种格式：**

**JSON格式（推荐）：**
```json
{
    "referer": "https://aigua.tv/",
    "origin": "https://aigua.tv",
    "sec-ch-ua": "\"Not;A=Brand\";v=\"99\", \"Google Chrome\";v=\"139\"",
    "sec-fetch-site": "cross-site"
}
```

**每行一个格式：**
```
referer: https://aigua.tv/
origin: https://aigua.tv
sec-ch-ua: "Not;A=Brand";v="99", "Google Chrome";v="139"
sec-fetch-site: cross-site
```

### 3. 添加下载任务

配置好请求头后：
1. 输入M3U8链接
2. 选择保存路径
3. 点击"添加下载任务"

状态栏会显示："已添加任务: xxx (包含 N 个自定义请求头)"

## 🧪 专用测试工具

运行 `python debug_launcher.py` 选择 **"3. 测试自定义请求头功能"**

### 测试选项：
1. **测试Aigua TV示例** - 直接测试您提供的网站配置
2. **测试自定义下载器** - 测试任意M3U8链接

### 优势：
- 只测试解析，不下载，速度快
- 显示详细调试信息
- 快速验证请求头是否有效

## 📋 您的Aigua TV示例

对于您提供的链接，有两种使用方法：

### 方法1：直接选择模板
在GUI中选择**"Aigua TV"**模板即可，我们已经内置了您提供的所有请求头。

### 方法2：手动配置
点击"请求头设置"，输入：
```json
{
    "accept": "*/*",
    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
    "cache-control": "no-cache",
    "origin": "https://aigua.tv",
    "pragma": "no-cache",
    "priority": "u=1, i",
    "referer": "https://aigua.tv/",
    "sec-ch-ua": "\"Not;A=Brand\";v=\"99\", \"Google Chrome\";v=\"139\", \"Chromium\";v=\"139\"",
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": "\"Windows\"",
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "cross-site",
    "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36"
}
```

## 🔍 调试和问题排查

### 查看详细日志
现在所有网络请求都有详细输出：
```
[DEBUG] 使用自定义请求头: {'referer': 'https://aigua.tv/', ...}
[DEBUG] 请求M3U8文件: https://example.com/index.m3u8
[DEBUG] 响应状态码: 200
[DEBUG] 解析完成，找到 50 个片段
```

### 常见错误和解决方案

**403 Forbidden：**
```
[DEBUG] 响应状态码: 403
```
解决：添加 `referer` 和 `origin` 请求头

**404 Not Found：**
```
[DEBUG] 响应状态码: 404
```
解决：检查URL是否正确，可能需要特定的User-Agent

**解析失败：**
```
[ERROR] 解析M3U8失败: 未找到任何视频片段
```
解决：检查返回内容是否是HTML页面而不是M3U8文件

### 最佳调试流程

1. **先用测试工具验证：**
   ```bash
   python debug_launcher.py
   # 选择 3 → 1 → 输入链接
   ```

2. **查看详细输出，确认：**
   - 状态码是否为200
   - 内容是否以#EXTM3U开头
   - 是否找到视频片段

3. **确认有效后再用GUI下载**

## 🛠️ 高级技巧

### 从浏览器获取请求头

1. 在浏览器中访问M3U8链接
2. 按F12打开开发者工具
3. 切换到"Network"标签
4. 刷新页面，找到M3U8请求
5. 右键 → "Copy as cURL" 或查看Request Headers
6. 复制相关请求头到我们的工具中

### 常用请求头说明

- **referer** - 来源页面，最重要的反盗链检查
- **origin** - 请求来源域名
- **user-agent** - 浏览器标识
- **sec-fetch-*** - 浏览器安全策略相关
- **accept-language** - 语言偏好

## ⚠️ 注意事项

1. **请求头会应用到所有请求** - M3U8文件、TS片段、密钥文件都会使用相同请求头
2. **某些网站可能有动态验证** - 如时间戳、签名等，这种情况仍然可能无法下载
3. **遵守法律法规** - 请确保下载内容符合相关法律和网站使用条款

## 🎉 成功示例

使用Aigua TV模板成功下载的日志：
```
[DEBUG] 下载器使用自定义请求头: {'referer': 'https://aigua.tv/', ...}
[DEBUG] 请求M3U8文件: https://cfav186.orangecloudapi.com/.../index.m3u8
[DEBUG] 响应状态码: 200
[DEBUG] 解析完成，找到 182 个片段
[DEBUG] 开始下载片段 0: https://cfav186.orangecloudapi.com/.../seg-1.ts
[DEBUG] 片段 0 下载完成，大小: 245760 字节
✅ 下载完成！
```

现在您就可以轻松绕过反爬虫限制，下载各种受保护的M3U8视频了！🚀
